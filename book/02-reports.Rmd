# Reports with R Markdown {#reports}

## Intended Learning Outcomes {#ilo-reports}

-   Be able to knit a simple reproducible report with R Markdown
-   Be able to edit Markdown to show/hide code and use inline coding
-   Be able to identify different types of data


## Setup {#setup-repro}

```{r, message=FALSE}
library(tidyverse)
library(knitr)
```

## Organising a project {#projects}

First, we need to get organised.

`r glossary("project", "Projects")` in RStudio are a way to group all of the files you need for one project. Most projects include scripts, data files, and output files like the PDF version of the script or images.

::: {.try data-latex=""}
Make a new `r glossary("directory")` where you will keep all of your materials for this class.

Choose **`New Project...`** under the **`File`** menu to create a new project called `r path("02-reports")` in this directory.
:::

### Working Directory

Where should you put all of your files? You usually want to have all of your scripts and data files in one subtree of your computer's directory structure. Usually there is a single `r glossary("working directory")` where your data and scripts are stored.

Your script should only reference files in three locations, using the appropriate format.

| Where                    | Example                                                          |
|--------------------------|------------------------------------------------------------------|
| on the web               | "<https://psyteachr.github.io/ads-v1/data/widgets_gadgets.xlsx>" |
| in the working directory | "widgets_gadgets.xlsx"                                           |
| in a subdirectory        | "data/widgets_gadgets.xlsx"                                      |

::: {.warning data-latex=""}
Never set or change your working directory in a script.
:::

R Markdown files will automatically use the same directory the .Rmd file is in as the working directory.

If your script needs a file in a subdirectory of your working directory, such as, `r path("data/widgets_gadgets.xlsx")`, load it in using a `r glossary("relative path")` so that it is accessible if you move the working directory to another location or computer:

```{r read-csv, eval = FALSE}
dat <- read_csv("data/widgets_gadgets.xlsx")  # correct
```

Do not load it in using an `r glossary("absolute path")`:

```{r abs-path, eval = FALSE}
dat <- read_csv("C:/Carla's_files/yearly_reports/2020-2021/data/widgets_gadgets.xlsx")   # wrong
```

::: {.info data-latex=""}
Also note the convention of using forward slashes, unlike the Windows-specific convention of using backward slashes. This is to make references to files platform independent.
:::

### Naming Things

Name files so that both people and computers can easily find things. Here are some important principles:

-   file and directory names should only contain letters, numbers, dashes, and underscores, with a full stop (`.`) between the file name and `r glossary("extension")` (that means no spaces!)
-   be consistent with capitalisation (I prefer to never use it to make it easy to remember)
-   use underscores (`_`) to separate parts of the file name, and dashes (`-`) to separate words in a section
-   name files with a pattern that alphabetises in a sensible order and makes it easy for you to find the file you're looking for
-   prefix a filename with an underscore to move it to the top of the list, or prefix all files with numbers to control their order

For example, these file names are a mess:

-   `r path("report.doc")`
-   `r path("report final.doc")`
-   `r path("Data (Customers) 11-15.xls")`
-   `r path("Customers Data Nov 12.xls")`
-   `r path("final report2.doc")`
-   `r path("project notes.txt")`
-   `r path("Vendor Data November 15.xls")`

Here is one way to structure them so that similar files have the same structure and it's easy for a human to scan the list or to use code to find relevant files. See if you can figure out what the last one should be.

-   `r path("_project-notes.txt")`
-   `r path("report_v1.doc")`
-   `r path("report_v2.doc")`
-   `r path("report_v3.doc")`
-   `r path("data_customer_2021-11-12.xls")`
-   `r path("data_customer_2021-11-15.xls")`
-   `r mcq(c("vendor-data_2021-11-15.xls", "data-vendor-2021_11_15.xls", answer = "data_vendor_2021-11-15.xls", "data_2021-11-15_vendor.xls"))`

::: {.try data-latex=""}
Think of other ways to name the files above. Look at some of your own project files and see what you can improve.
:::

## R Markdown

In this lesson, we will learn to make an R Markdown document with a table of contents, appropriate headers, tables, images, and inline R.

We will use `r glossary("R Markdown")` to create reproducible reports, which enables mixing of text and code. A reproducible script will contain sections of code in code blocks. A code block starts and ends with three backtick symbols in a row, with some information about the code between curly brackets, such as `{r chunk-name, echo=FALSE}` (this runs the code, but does not show the text of the code block in the compiled document). The text outside of code blocks is written in `r glossary("markdown")`, which is a way to specify formatting, such as headers, paragraphs, lists, bolding, and links.

If you open up a new R Markdown file from a template, you will see an example document with several code blocks in it. To create an HTML or PDF report from an R Markdown (Rmd) document, you compile it. Compiling a document is called `r glossary("knit", "knitting")` in RStudio. There is a button that looks like a ball of yarn with needles through it that you click on to compile your file into a report.

::: {.try data-latex=""}
Create a new R Markdown file from the **`File > New File > R Markdown...`** menu. Change the title and author, then click the knit button to create an html file.
:::

### YAML Header

The `r glossary("YAML")` header is where you can set several options.

    ---
    title: "My Demo Document"
    author: "Me"
    output:
      html_document:
        df_print: kable
        theme: 
          version: 4
          bootswatch: yeti
        toc: true
        toc_float:
          collapsed: false
          smooth_scroll: false
        toc_depth: 3
        number_sections: false
    ---

::: {.info data-latex=""}
Try changing the values from `false` to `true` to see what the options do.
:::

The `df_print: kable` option prints data frames using `knitr::kable`. You'll learn below how to further customise tables.

The built-in bootswatch themes are: default, cerulean, cosmo, darkly, flatly, journal, lumen, paper, readable, sandstone, simplex, spacelab, united, and yeti. You can [view and download more themes](https://bootswatch.com/4/).

```{r img-bootswatch, echo=FALSE, fig.cap="Light themes in versions 3 and 4."}
knitr::include_graphics("images/bootswatch.png")
```

### Setup

When you create a new R Markdown file in RStudio, a setup chunk is automatically created.

```{r knitr-setup, eval=FALSE, verbatim="r setup, include=FALSE"}
knitr::opts_chunk$set(echo = TRUE)
```

You can set more default options for your document here.

```{r knitr-setup2, eval=FALSE, verbatim="r setup, include=FALSE"}
knitr::opts_chunk$set(
  fig.width  = 8, 
  fig.height = 5, 
  fig.path   = 'images/',
  echo       = FALSE, 
  warning    = TRUE, 
  message    = FALSE,
  cache      = FALSE
)
```

The code above sets the following options:

-   `fig.width  = 8` : default figure width is 8 inches (you can change this for individual figures)
-   `fig.height = 5` : default figure height is 5 inches
-   `fig.path   = 'images/'` : figures are saved in the directory "images"
-   `echo       = FALSE` : do not show code chunks in the rendered document
-   `warning    = FALSE` : do not show any function warnings
-   `message    = FALSE` : do not show any function messages
-   `cache      = FALSE` : run all the code to create all of the images and objects each time you knit (set to `TRUE` if you have time-consuming code)

Find a list of the current chunk options by typing `r hl(str(knitr::opts_chunk$get()))` in the console. See the [knitr options documentation](https://yihui.name/knitr/options/){target="_blank"} for explanations of the possible options.

You can also add the packages you need in this chunk using `r hl(library())`. Often when you are working on a script, you will realize that you need to load another add-on package. Don't bury the call to `r hl(library(package_I_need))` way down in the script. Put it in the top, so the user has an overview of what packages are needed.

::: {.try data-latex=""}
We'll frequently use functions from the package `r pkg("tidyverse")`, so load that in your setup chunk using the code `r mcq(c('install.packages("tidyverse")', answer = 'library(tidyverse)', 'load(tidyverse)'))`
:::

### Markdown {#structure}

You can use the visual `r glossary("markdown")` editor if you have RStudio version 1.4 or higher. This will be a button at the top of the source pane with a pen tip. This is useful for complex styling, but you can also use these common plain-text style markups:

-   Headers are created by prefacing subtitles with one or more hashes (`#`). If you include a table of contents (`toc`) in the YAML, it is created from your document headers.
-   Format text with *italics* or **bold** by surrounding the text with one or two asterisks or underscores.
-   Make lists using numbers, asterisks or dashes before items. Indent items to make nested lists.
-   Make links like this: `[psyTeachR](https://psyteachr.github.io/)`

Download the [R Markdown Cheat Sheet](http://www.rstudio.com/wp-content/uploads/2016/03/rmarkdown-cheatsheet-2.0.pdf) to learn more.

::: {.try data-latex=""}
Delete the default text and add some structure to your document by creating headers and subheaders. We're going to present a summary table and plot the data.
:::

### Code Chunks

You can include `r glossary("chunk", "code chunks")` that create and display images, tables, or computations to include in your text. Let's start by loading some data.

First, create a code chunk in your document. You can type in the backticks and chunk header manually, or use a keyboard shortcut (alt-cmd-I). This code loads some data from the web.

```{r, message=FALSE, meverbatim="r"}
# https://www.kaggle.com/kyanyoga/sample-sales-data
sales <- read_csv("data/sales_data_sample.csv")
```

You can add comments inside R chunks with the hash symbol (`#`). The R interpreter will ignore characters from the hash to the end of the line.

```{r}
# important numbers

n <- nrow(sales) # the total number of sales
first <- min(sales$YEAR_ID) # the first year in the table
last <- max(sales$YEAR_ID) # the last year in the table
```

It's usually good practice to start a code chunk with a comment that explains what you're doing there, especially if the code is not explained in the text of the report.

If you name your objects clearly, you often don't need to add clarifying comments. For example, if I'd named the three objects above `total_number_of_sales`, `first_year` and `last_year`, I would omit the comments. It's a bit of an art to comment your code well.

### Tables

Next, create a code chunk where you want to display a summary table. We'll use tidyverse functions you will learn in the [data wrangling lectures](#tidyr) to count the number of products per year for each product line.

```{r}
summary_table <- sales %>%
  group_by(YEAR_ID, PRODUCTLINE) %>%
  count() %>%
  spread(key = YEAR_ID, value = n) %>%
  print()
```

The table above is OK, but it could be more reader-friendly by changing the column labels and adding a caption. You can also use more specialised functions from `r pkg("kableExtra")` to format your tables. These are very powerful, but take practice.

```{r}
library(kableExtra)

kable(summary_table, 
      col.names = c("", "2003", "2004", "2005"),
      caption = "Number of sales per product line each year.") %>%
  add_header_above(c("Product Lines" = 1, "Sales" = 3), line = F, bold = T) %>%
  row_spec(0, color = "grey") %>%
  kable_classic(full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  # highlight sales over 200 in red
  column_spec(2, color = ifelse(summary_table$`2003` > 200, "red", "black")) %>%
  column_spec(3, color = ifelse(summary_table$`2004` > 200, "red", "black")) %>%
  column_spec(4, color = ifelse(summary_table$`2005` > 200, "red", "black")) 
```

::: {.try data-latex=""}
See how many different ways you can style the table above. Use the [kableExtra vignette](https://haozhu233.github.io/kableExtra/awesome_table_in_html.html){target="_blank"} for inspiration.
:::

### Images

Next, create a code chunk where you want to display an image in your document. Let's put it after the table. We'll use some code that you'll learn more about in Chapter \@ref(viz) to show the range of sales within each country.

Notice how the figure caption is formatted in the chunk options.

```{r item-by-line, fig.cap="The number of items in each order by product line.", verbatim="r item-by-line, fig.cap=\"The number of items in each order by product line.\""}
ggplot(sales, aes(x = COUNTRY, y = SALES, fill = COUNTRY)) +
  geom_violin(alpha = 0.5, show.legend = FALSE) +
  xlab("") +
  scale_y_continuous(name = "Sales per order", 
                     breaks = seq(0, 14000, 2000), 
                     labels = paste0("£", seq(0, 14, 2), "K")) +
  scale_fill_viridis_d() +
  theme(text = element_text(size = 20, family = "Times"),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

![All the Things by [Hyperbole and a Half](images/memes/x-all-the-things.png){float: right; style="width:50%"} You can also include images that you did not create in R using the markdown syntax for images:

    ![All the Things by Hyperbole and a Half](images/memes/x-all-the-things.png){style="float: right; width:50%"}

### In-line R

Sometimes you just need to insert a number from the data into some text in your report. Inline R code lets you do that. First, we'll calculate the total number of sales per year in a code block. This block can be hidden in the final report.

```{r}
sales_per_year <- sales %>%
  group_by(YEAR_ID) %>%
  summarise(total = sum(SALES)) %>%
  # this adds commas as thousands separators
  mutate(fmt = format(total, big.mark=","))

sales03 <- sales_per_year %>% filter(YEAR_ID == 2003) %>% pull(fmt)
sales04 <- sales_per_year %>% filter(YEAR_ID == 2004) %>% pull(fmt)
sales05 <- sales_per_year %>% filter(YEAR_ID == 2005) %>% pull(fmt)
```

You can insert the results into a paragraph with inline R code that looks like this:

```{=html}
<pre><code>The total sales per year were 
£`r sales03` (2003), 
£`r sales04` (2004), and 
£`r sales05` (2005).</code></pre>
```
**Rendered text:**

The total sales per year were £`r sales03` (2003), £`r sales04` (2004), and £`r sales05` (2005).

::: {.info data-latex=""}
In a markdown document, new paragraphs are only created when you skip a blank line. If you include a single line break in a sentence, like above, it won't show up in the report. This can be a good way to organise complicated text with inline code.
:::

### Output Formats

You can knit your file to PDF or Word if you have the right packages installed on your computer. You can also create presentations, dashboards, websites, and even books with R markdown, which we'll learn more about in Chapter \@ref(present). In fact, the book you are reading right now was created using R markdown.


## Glossary {#glossary-reports}

`r glossary_table()`

## Further Resources {#resources-repro}

-   [R Markdown Cheat Sheet](http://www.rstudio.com/wp-content/uploads/2016/03/rmarkdown-cheatsheet-2.0.pdf)
-   [kableExtra](https://haozhu233.github.io/kableExtra/awesome_table_in_html.html)
-   [R Markdown reference Guide](https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf)
-   [R Markdown Tutorial](https://rmarkdown.rstudio.com/lesson-1.html)
-   [R Markdown: The Definitive Guide](https://bookdown.org/yihui/rmarkdown/) by Yihui Xie, J. J. Allaire, & Garrett Grolemund
-   [Project Structure](https://slides.djnavarro.net/project-structure/) by Danielle Navarro
-   [How to name files](https://speakerdeck.com/jennybc/how-to-name-files) by Jenny Bryan
