<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 8 Data Wrangling | Applied Data Skills</title>
<meta name="author" content="Emily Nordmann and Lisa DeBruine">
<meta name="description" content="8.1 Intended Learning Outcomes Be able to select and filter data for relevance Be able to create new columns and edit existing ones library(tidyverse)  # data wrangling functions...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 8 Data Wrangling | Applied Data Skills">
<meta property="og:type" content="book">
<meta property="og:url" content="https://psyteachr.github.io/ads-v1/wrangle.html">
<meta property="og:image" content="https://psyteachr.github.io/ads-v1/images/logos/logo">
<meta property="og:description" content="8.1 Intended Learning Outcomes Be able to select and filter data for relevance Be able to create new columns and edit existing ones library(tidyverse)  # data wrangling functions...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 8 Data Wrangling | Applied Data Skills">
<meta name="twitter:description" content="8.1 Intended Learning Outcomes Be able to select and filter data for relevance Be able to create new columns and edit existing ones library(tidyverse)  # data wrangling functions...">
<meta name="twitter:image" content="https://psyteachr.github.io/ads-v1/images/logos/logo">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><script src="libs/plotly-binding-4.10.0/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.19/datatables.js"></script><link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-6NP3MF25W3"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-6NP3MF25W3');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="include/psyteachr.css">
<link rel="stylesheet" href="include/webex.css">
<link rel="stylesheet" href="include/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Processing &amp; Presenting Data">Applied Data Skills</a>:
        <small class="text-muted">Processing &amp; Presenting Data</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Overview</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Intro to R and RStudio</a></li>
<li><a class="" href="reports.html"><span class="header-section-number">2</span> Reports with R Markdown</a></li>
<li><a class="" href="viz.html"><span class="header-section-number">3</span> Basic Data Visualisation</a></li>
<li><a class="" href="data.html"><span class="header-section-number">4</span> Data Import</a></li>
<li><a class="" href="summary.html"><span class="header-section-number">5</span> Data Summaries</a></li>
<li><a class="" href="joins.html"><span class="header-section-number">6</span> Data Relations</a></li>
<li><a class="" href="tidy.html"><span class="header-section-number">7</span> Data Tidying</a></li>
<li><a class="active" href="wrangle.html"><span class="header-section-number">8</span> Data Wrangling</a></li>
<li><a class="" href="custom.html"><span class="header-section-number">9</span> Customising Visualisations</a></li>
<li><a class="" href="present.html"><span class="header-section-number">10</span> Advanced Reports</a></li>
<li class="book-part">Appendices</li>
<li><a class="" href="installing-r.html"><span class="header-section-number">A</span> Installing R</a></li>
<li><a class="" href="appendix-updating-r.html"><span class="header-section-number">B</span> Updating R, RStudio, and packages</a></li>
<li><a class="" href="symbols.html"><span class="header-section-number">C</span> Symbols</a></li>
<li><a class="" href="conventions.html"><span class="header-section-number">D</span> Conventions</a></li>
<li><a class="" href="data-types.html"><span class="header-section-number">E</span> Data Types</a></li>
<li><a class="" href="plotstyle.html"><span class="header-section-number">F</span> Styling Plots</a></li>
<li><a class="" href="twitter-example.html"><span class="header-section-number">G</span> Twitter Example</a></li>
<li><a class="" href="webpages.html"><span class="header-section-number">H</span> Webpages</a></li>
<li><a class="" href="license.html">License</a></li>
<li><a class="" href="references-1.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/psyteachr/ads-v1">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="wrangle" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> Data Wrangling<a class="anchor" aria-label="anchor" href="#wrangle"><i class="fas fa-link"></i></a>
</h1>
<div id="ilo-wrangle" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> Intended Learning Outcomes<a class="anchor" aria-label="anchor" href="#ilo-wrangle"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>Be able to select and filter data for relevance</li>
<li>Be able to create new columns and edit existing ones</li>
</ul>
<div class="sourceCode" id="cb264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>   <span class="co"># data wrangling functions</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>   <span class="co"># for handling dates and times</span></code></pre></div>
</div>
<div id="wrangling-functions" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Wrangling functions<a class="anchor" aria-label="anchor" href="#wrangling-functions"><i class="fas fa-link"></i></a>
</h2>
<p>Most <a class="glossary" target="_blank" title="The process of preparing data for visualisation and statistical analysis." href="https://psyteachr.github.io/glossary/d#data-wrangling">data wrangling</a> involves the reshaping functions you learned in Chapter <a href="tidy.html#tidy">7</a> and these six functions: <code>select</code>, <code>filter</code>, <code>arrange</code>, <code>mutate</code>, <code>summarise</code>, and <code>group_by</code>. We'll cover the first four in this chapter, and the last two in Chapter <a href="reports.html#summary">2.6.5</a>.</p>
<p>We'll use a small example table with the sales and expenses for two years from four regions over two products.</p>
<div class="sourceCode" id="cb265"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">budget</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"data/budget.csv"</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
region
</th>
<th style="text-align:left;">
product
</th>
<th style="text-align:right;">
sales_2019
</th>
<th style="text-align:right;">
sales_2020
</th>
<th style="text-align:right;">
expenses_2019
</th>
<th style="text-align:right;">
expenses_2020
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
North
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
12029
</td>
<td style="text-align:right;">
9383
</td>
<td style="text-align:right;">
10722
</td>
<td style="text-align:right;">
9003
</td>
</tr>
<tr>
<td style="text-align:left;">
North
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
5673
</td>
<td style="text-align:right;">
5027
</td>
<td style="text-align:right;">
5987
</td>
<td style="text-align:right;">
6065
</td>
</tr>
<tr>
<td style="text-align:left;">
South
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
11023
</td>
<td style="text-align:right;">
8450
</td>
<td style="text-align:right;">
10904
</td>
<td style="text-align:right;">
10572
</td>
</tr>
<tr>
<td style="text-align:left;">
South
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
6972
</td>
<td style="text-align:right;">
4005
</td>
<td style="text-align:right;">
4340
</td>
<td style="text-align:right;">
5150
</td>
</tr>
<tr>
<td style="text-align:left;">
East
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
9172
</td>
<td style="text-align:right;">
9849
</td>
<td style="text-align:right;">
9099
</td>
<td style="text-align:right;">
9558
</td>
</tr>
<tr>
<td style="text-align:left;">
East
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
4527
</td>
<td style="text-align:right;">
4596
</td>
<td style="text-align:right;">
5044
</td>
<td style="text-align:right;">
6986
</td>
</tr>
<tr>
<td style="text-align:left;">
West
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
10533
</td>
<td style="text-align:right;">
10690
</td>
<td style="text-align:right;">
10683
</td>
<td style="text-align:right;">
9585
</td>
</tr>
<tr>
<td style="text-align:left;">
West
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
6154
</td>
<td style="text-align:right;">
5376
</td>
<td style="text-align:right;">
5383
</td>
<td style="text-align:right;">
4814
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="select" class="section level3" number="8.2.1">
<h3>
<span class="header-section-number">8.2.1</span> Select<a class="anchor" aria-label="anchor" href="#select"><i class="fas fa-link"></i></a>
</h3>
<p>Select columns by name or number.</p>
<p>You can select each column individually, separated by commas (e.g., <code>region, sales_2019</code>). You can also select all columns between two columns by separating them with a colon (e.g., <code>sales_2019:expenses_2020</code>).</p>
<div class="sourceCode" id="cb266"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">budget2020</span> <span class="op">&lt;-</span> <span class="va">budget</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">region</span>, <span class="va">sales_2020</span>, <span class="va">expenses_2020</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">budget2020</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "region"        "sales_2020"    "expenses_2020"</code></pre>
<p>You can select columns by number, which is useful when the column names are long or complicated.</p>
<div class="sourceCode" id="cb268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">regions</span> <span class="op">&lt;-</span> <span class="va">budget</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">regions</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "region"        "sales_2019"    "sales_2020"    "expenses_2019"
## [5] "expenses_2020"</code></pre>
<p>You can use a minus symbol to unselect columns, leaving all of the other columns. If you want to exclude a span of columns, put parentheses around the span first, e.g., <code>-(sales_2019:expenses_2020)</code>, not <code>-sales_2019:expenses_2020</code>.</p>
<div class="sourceCode" id="cb270"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sales</span> <span class="op">&lt;-</span> <span class="va">budget</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">expenses_2019</span><span class="op">:</span><span class="va">expenses_2020</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sales</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "region"     "product"    "sales_2019" "sales_2020"</code></pre>
<p>You can select columns based on criteria about the column names.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>function</th>
<th>definition</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>starts_with()</code></td>
<td>select columns that start with a character string</td>
</tr>
<tr class="even">
<td><code>ends_with()</code></td>
<td>elect columns that end with a character string</td>
</tr>
<tr class="odd">
<td><code>contains()</code></td>
<td>select columns that contain a character string</td>
</tr>
<tr class="even">
<td><code>num_range()</code></td>
<td>select columns with a name that matches the pattern <code>prefix</code>
</td>
</tr>
</tbody>
</table></div>
<div class="info">
<p>Use <code>width</code> to set the number of digits with leading
zeros. For example, <code>num_range('var_', 8:10, width=2)</code> selects columns <code>var_08</code>, <code>var_09</code>, and <code>var_10</code>.</p>
</div>
<div class="try">
<p>What are the resulting columns for these four examples?</p>
<ul>
<li>
<code>budget %&gt;% select(starts_with("sales"))</code>
<select class="webex-select"><option value="blank"></option>
<option value="x">sales_2019, sales_2020, expenses_2019, expenses_2020</option>
<option value="x">expenses_2019, expenses_2020</option>
<option value="x">sales_2020, expenses_2020</option>
<option value="answer">sales_2019, sales_2020</option></select>
</li>
<li>
<code>budget %&gt;% select(ends_with("2020"))</code>
<select class="webex-select"><option value="blank"></option>
<option value="x">sales_2019, sales_2020</option>
<option value="answer">sales_2020, expenses_2020</option>
<option value="x">expenses_2019, expenses_2020</option>
<option value="x">sales_2019, sales_2020, expenses_2019, expenses_2020</option></select>
</li>
<li>
<code>budget %&gt;% select(contains("_"))</code>
<select class="webex-select"><option value="blank"></option>
<option value="x">expenses_2019, expenses_2020</option>
<option value="x">sales_2020, expenses_2020</option>
<option value="x">sales_2019, sales_2020</option>
<option value="answer">sales_2019, sales_2020, expenses_2019, expenses_2020</option></select>
</li>
<li>
<code>budget %&gt;% select(num_range("expenses_", 2019:2020))</code>
<select class="webex-select"><option value="blank"></option>
<option value="answer">expenses_2019, expenses_2020</option>
<option value="x">sales_2019, sales_2020</option>
<option value="x">sales_2020, expenses_2020</option>
<option value="x">sales_2019, sales_2020, expenses_2019, expenses_2020</option></select>
</li>
</ul>
</div>
</div>
<div id="filter" class="section level3" number="8.2.2">
<h3>
<span class="header-section-number">8.2.2</span> Filter<a class="anchor" aria-label="anchor" href="#filter"><i class="fas fa-link"></i></a>
</h3>
<p>Select rows by matching column criteria.</p>
<div class="sourceCode" id="cb272"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># select all rows from the North region</span>
<span class="va">budget</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"North"</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
region
</th>
<th style="text-align:left;">
product
</th>
<th style="text-align:right;">
sales_2019
</th>
<th style="text-align:right;">
sales_2020
</th>
<th style="text-align:right;">
expenses_2019
</th>
<th style="text-align:right;">
expenses_2020
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
North
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
12029
</td>
<td style="text-align:right;">
9383
</td>
<td style="text-align:right;">
10722
</td>
<td style="text-align:right;">
9003
</td>
</tr>
<tr>
<td style="text-align:left;">
North
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
5673
</td>
<td style="text-align:right;">
5027
</td>
<td style="text-align:right;">
5987
</td>
<td style="text-align:right;">
6065
</td>
</tr>
</tbody>
</table></div>
</div>
<div class="warning">
<p>Remember to use <code><a href="https://rdrr.io/r/base/Comparison.html">==</a></code> and not <code><a href="https://rdrr.io/r/base/assignOps.html">=</a></code> to check if two things are equivalent. A single <code><a href="https://rdrr.io/r/base/assignOps.html">=</a></code> assigns the righthand value to the lefthand variable and (usually) evaluates to <code>TRUE</code>.</p>
</div>
<p>You can select on multiple criteria by separating them with commas.</p>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">budget</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span>
  <span class="va">region</span> <span class="op">==</span> <span class="st">"North"</span>,
  <span class="va">product</span> <span class="op">==</span> <span class="st">"widgets"</span>
<span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
region
</th>
<th style="text-align:left;">
product
</th>
<th style="text-align:right;">
sales_2019
</th>
<th style="text-align:right;">
sales_2020
</th>
<th style="text-align:right;">
expenses_2019
</th>
<th style="text-align:right;">
expenses_2020
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
North
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
12029
</td>
<td style="text-align:right;">
9383
</td>
<td style="text-align:right;">
10722
</td>
<td style="text-align:right;">
9003
</td>
</tr></tbody>
</table></div>
</div>
<p>You can use the symbols <code><a href="https://rdrr.io/r/base/Logic.html">&amp;</a></code>, <code><a href="https://rdrr.io/r/base/Logic.html">|</a></code>, and <code><a href="https://rdrr.io/r/base/Logic.html">!</a></code> to mean "and", "or", and "not". You can also use other operators to make equations. The equation is checked for each row, and if the result is FALSE, the row is removed.</p>
<div class="sourceCode" id="cb274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># regions and products with profit in both 2019 and 2020</span>
<span class="va">profit_both</span> <span class="op">&lt;-</span> <span class="va">budget</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span>
    <span class="va">sales_2019</span> <span class="op">&gt;</span> <span class="va">expenses_2019</span> <span class="op">&amp;</span>
    <span class="va">sales_2020</span> <span class="op">&gt;</span> <span class="va">expenses_2020</span>
  <span class="op">)</span>

<span class="co"># regions and products with profit in 2019 or 2020</span>
<span class="va">profit_either</span> <span class="op">&lt;-</span> <span class="va">budget</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span>
    <span class="va">sales_2019</span> <span class="op">&gt;</span> <span class="va">expenses_2019</span> <span class="op">|</span>
    <span class="va">sales_2020</span> <span class="op">&gt;</span> <span class="va">expenses_2020</span>
  <span class="op">)</span>

<span class="co"># everything but the North</span>
<span class="va">not_north</span> <span class="op">&lt;-</span> <span class="va">budget</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">!=</span> <span class="st">"North"</span><span class="op">)</span>

<span class="co"># 2020 profit greater than 1000</span>
<span class="va">profit_1000</span> <span class="op">&lt;-</span> <span class="va">budget</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">sales_2020</span> <span class="op">-</span> <span class="va">expenses_2020</span> <span class="op">&gt;</span> <span class="fl">1000</span><span class="op">)</span></code></pre></div>
<p>The <a class="glossary" target="_blank" title="A binary operator (%in%) that returns a logical vector indicating if there is a match or not for its left operand." href="https://psyteachr.github.io/glossary/m#match-operator">match operator</a> (<code><a href="https://rdrr.io/r/base/match.html">%in%</a></code>) is useful here for testing if a column value is in a list.</p>
<div class="sourceCode" id="cb275"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">budget</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"North"</span>, <span class="st">"South"</span><span class="op">)</span> <span class="op">&amp;</span>
           <span class="va">product</span> <span class="op">==</span> <span class="st">"widgets"</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
region
</th>
<th style="text-align:left;">
product
</th>
<th style="text-align:right;">
sales_2019
</th>
<th style="text-align:right;">
sales_2020
</th>
<th style="text-align:right;">
expenses_2019
</th>
<th style="text-align:right;">
expenses_2020
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
North
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
12029
</td>
<td style="text-align:right;">
9383
</td>
<td style="text-align:right;">
10722
</td>
<td style="text-align:right;">
9003
</td>
</tr>
<tr>
<td style="text-align:left;">
South
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
11023
</td>
<td style="text-align:right;">
8450
</td>
<td style="text-align:right;">
10904
</td>
<td style="text-align:right;">
10572
</td>
</tr>
</tbody>
</table></div>
</div>
</div>
<div id="arrange" class="section level3" number="8.2.3">
<h3>
<span class="header-section-number">8.2.3</span> Arrange<a class="anchor" aria-label="anchor" href="#arrange"><i class="fas fa-link"></i></a>
</h3>
<p>Sort your dataset using <code>arrange()</code>. You will find yourself needing to sort data in R much less than you do in Excel, since you don't need to have rows next to each other in order to, for example, calculate group means. But <code>arrange()</code> can be useful when preparing data for display in tables. Reverse the order using <code>desc()</code>.</p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">budget</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">product</span>, <span class="fu">desc</span><span class="op">(</span><span class="va">region</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
region
</th>
<th style="text-align:left;">
product
</th>
<th style="text-align:right;">
sales_2019
</th>
<th style="text-align:right;">
sales_2020
</th>
<th style="text-align:right;">
expenses_2019
</th>
<th style="text-align:right;">
expenses_2020
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
West
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
6154
</td>
<td style="text-align:right;">
5376
</td>
<td style="text-align:right;">
5383
</td>
<td style="text-align:right;">
4814
</td>
</tr>
<tr>
<td style="text-align:left;">
South
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
6972
</td>
<td style="text-align:right;">
4005
</td>
<td style="text-align:right;">
4340
</td>
<td style="text-align:right;">
5150
</td>
</tr>
<tr>
<td style="text-align:left;">
North
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
5673
</td>
<td style="text-align:right;">
5027
</td>
<td style="text-align:right;">
5987
</td>
<td style="text-align:right;">
6065
</td>
</tr>
<tr>
<td style="text-align:left;">
East
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
4527
</td>
<td style="text-align:right;">
4596
</td>
<td style="text-align:right;">
5044
</td>
<td style="text-align:right;">
6986
</td>
</tr>
<tr>
<td style="text-align:left;">
West
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
10533
</td>
<td style="text-align:right;">
10690
</td>
<td style="text-align:right;">
10683
</td>
<td style="text-align:right;">
9585
</td>
</tr>
<tr>
<td style="text-align:left;">
South
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
11023
</td>
<td style="text-align:right;">
8450
</td>
<td style="text-align:right;">
10904
</td>
<td style="text-align:right;">
10572
</td>
</tr>
<tr>
<td style="text-align:left;">
North
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
12029
</td>
<td style="text-align:right;">
9383
</td>
<td style="text-align:right;">
10722
</td>
<td style="text-align:right;">
9003
</td>
</tr>
<tr>
<td style="text-align:left;">
East
</td>
<td style="text-align:left;">
widgets
</td>
<td style="text-align:right;">
9172
</td>
<td style="text-align:right;">
9849
</td>
<td style="text-align:right;">
9099
</td>
<td style="text-align:right;">
9558
</td>
</tr>
</tbody>
</table></div>
</div>
<div class="try">
<p>If you want to sort categories in a specific order, turn the column into a <a class="glossary" target="_blank" title="A data type where a specific set of values are stored with labels; An explanatory variable manipulated by the experimenter" href="https://psyteachr.github.io/glossary/f#factor">factor</a> and set the <code>levels</code> in the desired order.</p>
<div class="sourceCode" id="cb277"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">budget</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">region</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"North"</span>, <span class="st">"South"</span>, <span class="st">"East"</span>, <span class="st">"West"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">product</span> <span class="op">==</span> <span class="st">"gadgets"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">region</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
region
</th>
<th style="text-align:left;">
product
</th>
<th style="text-align:right;">
sales_2019
</th>
<th style="text-align:right;">
sales_2020
</th>
<th style="text-align:right;">
expenses_2019
</th>
<th style="text-align:right;">
expenses_2020
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
North
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
5673
</td>
<td style="text-align:right;">
5027
</td>
<td style="text-align:right;">
5987
</td>
<td style="text-align:right;">
6065
</td>
</tr>
<tr>
<td style="text-align:left;">
South
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
6972
</td>
<td style="text-align:right;">
4005
</td>
<td style="text-align:right;">
4340
</td>
<td style="text-align:right;">
5150
</td>
</tr>
<tr>
<td style="text-align:left;">
East
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
4527
</td>
<td style="text-align:right;">
4596
</td>
<td style="text-align:right;">
5044
</td>
<td style="text-align:right;">
6986
</td>
</tr>
<tr>
<td style="text-align:left;">
West
</td>
<td style="text-align:left;">
gadgets
</td>
<td style="text-align:right;">
6154
</td>
<td style="text-align:right;">
5376
</td>
<td style="text-align:right;">
5383
</td>
<td style="text-align:right;">
4814
</td>
</tr>
</tbody>
</table></div>
</div>
</div>
</div>
<div id="mutate" class="section level3" number="8.2.4">
<h3>
<span class="header-section-number">8.2.4</span> Mutate<a class="anchor" aria-label="anchor" href="#mutate"><i class="fas fa-link"></i></a>
</h3>
<p>Add new columns or change existing ones. Refer to other columns by their names (unquoted). You can add more than one column in the same mutate function, just separate the columns with a comma. Once you make a new column, you can use it in further column definitions e.g., <code>profit</code> below).</p>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">budget2</span> <span class="op">&lt;-</span> <span class="va">budget</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    sales <span class="op">=</span> <span class="va">sales_2019</span> <span class="op">+</span> <span class="va">sales_2020</span>,
    expenses <span class="op">=</span> <span class="va">expenses_2019</span> <span class="op">+</span> <span class="va">expenses_2020</span>,
    profit <span class="op">=</span> <span class="va">sales</span> <span class="op">-</span> <span class="va">expenses</span>,
    region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">region</span>, <span class="st">"Office"</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<div class="warning">
<p>You can overwrite a column by giving a new column the same name as the old column (see <code>region</code>) above. Make sure that you mean to do this and that you aren't trying to use the old column value after you redefine it.</p>
</div>
<p>Load some data about the population of the Scottish counties.</p>
<div class="sourceCode" id="cb279"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scotpop</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"data/scottish_population.csv"</span>,
                    show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Transform the population value to the nearest thousands (e.g., 3433 would be "3K"), order from most to least populous, put the columns in the order <code>population</code> (in K) then <code>county</code>, and show only the counties with populations greater than 200K.</p>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
population
</th>
<th style="text-align:left;">
county
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
593K
</td>
<td style="text-align:left;">
Glasgow
</td>
</tr>
<tr>
<td style="text-align:left;">
486K
</td>
<td style="text-align:left;">
Edinburgh
</td>
</tr>
<tr>
<td style="text-align:left;">
365K
</td>
<td style="text-align:left;">
Fife
</td>
</tr>
<tr>
<td style="text-align:left;">
326K
</td>
<td style="text-align:left;">
North Lanarkshire
</td>
</tr>
<tr>
<td style="text-align:left;">
312K
</td>
<td style="text-align:left;">
South Lanarkshire
</td>
</tr>
<tr>
<td style="text-align:left;">
246K
</td>
<td style="text-align:left;">
Aberdeenshire
</td>
</tr>
<tr>
<td style="text-align:left;">
222K
</td>
<td style="text-align:left;">
Highland
</td>
</tr>
<tr>
<td style="text-align:left;">
217K
</td>
<td style="text-align:left;">
Aberdeen
</td>
</tr>
</tbody>
</table></div>
</div>
<div class="try">
<p>There are several different ways you could make the table above. Some functions could be in a different order and some couldn't. See where you can move the <code><a href="https://rdrr.io/r/stats/filter.html">filter()</a></code> and <code>arrange()</code> functions.</p>
</div>
<div class="webex-solution">
<button>
Solution
</button>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scotpop</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">population</span> <span class="op">&gt;</span> <span class="fl">200000</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>kpop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">population</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"K"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span>population <span class="op">=</span> <span class="va">kpop</span>, 
         county <span class="op">=</span> <span class="va">name</span><span class="op">)</span></code></pre></div>
</div>
</div>
</div>
<div id="together-wrangle" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> Putting it together<a class="anchor" aria-label="anchor" href="#together-wrangle"><i class="fas fa-link"></i></a>
</h2>
<p>Load some demo data we first used in Chapter <a href="data.html#data">4</a>. Use <code>glimpse()</code> or another method to get familiar with the data set.</p>
<div class="sourceCode" id="cb281"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># from https://www.kaggle.com/kyanyoga/sample-sales-data</span>
<span class="va">sales</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"data/sales_data_sample.csv"</span>,
                  show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Double check that the <code>SALES</code> column does equal the <code>QUANTITYORDERED</code> column times the <code>PRICEEACH</code>. You can select just the columns you need and rename them when selecting to make the code more readable.</p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sales_check</span> <span class="op">&lt;-</span> <span class="va">sales</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">SALES</span>, n <span class="op">=</span> <span class="va">QUANTITYORDERED</span>, price <span class="op">=</span> <span class="va">PRICEEACH</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>total <span class="op">=</span> <span class="va">n</span> <span class="op">*</span> <span class="va">price</span><span class="op">)</span></code></pre></div>
<p>Make a table of any rows where the value of <code>total</code> doesn't equal <code>SALES</code>.</p>
<div class="sourceCode" id="cb283"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">errors</span> <span class="op">&lt;-</span> <span class="va">sales_check</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">SALES</span> <span class="op">!=</span> <span class="va">total</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">errors</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:right;">
SALES
</th>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
price
</th>
<th style="text-align:right;">
total
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
2765.90
</td>
<td style="text-align:right;">
34
</td>
<td style="text-align:right;">
81.35
</td>
<td style="text-align:right;">
2765.90
</td>
</tr>
<tr>
<td style="text-align:right;">
3884.34
</td>
<td style="text-align:right;">
41
</td>
<td style="text-align:right;">
94.74
</td>
<td style="text-align:right;">
3884.34
</td>
</tr>
<tr>
<td style="text-align:right;">
3746.70
</td>
<td style="text-align:right;">
45
</td>
<td style="text-align:right;">
83.26
</td>
<td style="text-align:right;">
3746.70
</td>
</tr>
<tr>
<td style="text-align:right;">
5205.27
</td>
<td style="text-align:right;">
49
</td>
<td style="text-align:right;">
100.00
</td>
<td style="text-align:right;">
4900.00
</td>
</tr>
<tr>
<td style="text-align:right;">
3479.76
</td>
<td style="text-align:right;">
36
</td>
<td style="text-align:right;">
96.66
</td>
<td style="text-align:right;">
3479.76
</td>
</tr>
<tr>
<td style="text-align:right;">
5512.32
</td>
<td style="text-align:right;">
48
</td>
<td style="text-align:right;">
100.00
</td>
<td style="text-align:right;">
4800.00
</td>
</tr>
</tbody>
</table></div>
</div>
<p>If you check the <code>errors</code> table, you'll see that 1697 of the original 2823 rows have "errors", even though many of the values in the <code>SALES</code> and <code>sales_check</code> columns look identical. You can fix this by rounding the value of <code>total</code> to 2 decimal places.</p>
<div class="info">
<p>This is due to the way values with decimal places are represented by a computer. You use base 10 to count, and have to represent some numbers with a repeating decimal, like 1/3 is .0333 repeating, while a computer uses binary to count, and has to represent different numbers using repeats. This can lead to very small differences when you divide or multiply some numbers.</p>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>scipen <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="co"># avoids scientific notation</span>
<span class="va">x</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">49</span> <span class="op">*</span> <span class="fl">49</span><span class="op">)</span>
<span class="va">x</span> <span class="co"># prints as 1</span>
<span class="fl">1</span><span class="op">-</span><span class="va">x</span> <span class="co"># but is actually very slightly smaller</span></code></pre></div>
<pre><code>## [1] 1
## [1] 0.0000000000000001110223</code></pre>
</div>
<div class="sourceCode" id="cb286"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">errors</span> <span class="op">&lt;-</span> <span class="va">sales_check</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">SALES</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">total</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>There are still 1304 errors! Lets look at the 10 smallest. We can do this by calculating the difference, arranging from smallest to largest, and filtering for the first 10 rows.</p>
<div class="sourceCode" id="cb287"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">errors</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>diff <span class="op">=</span> <span class="va">SALES</span> <span class="op">-</span> <span class="va">total</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">diff</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<p>Alternatively, we can use a <code>slice</code> function.</p>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">errors</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>diff <span class="op">=</span> <span class="va">SALES</span> <span class="op">-</span> <span class="va">total</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">slice_min</span><span class="op">(</span>order_by <span class="op">=</span> <span class="va">diff</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:right;">
SALES
</th>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
price
</th>
<th style="text-align:right;">
total
</th>
<th style="text-align:right;">
diff
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
2600.26
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
2600
</td>
<td style="text-align:right;">
0.26
</td>
</tr>
<tr>
<td style="text-align:right;">
3602.16
</td>
<td style="text-align:right;">
36
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
3600
</td>
<td style="text-align:right;">
2.16
</td>
</tr>
<tr>
<td style="text-align:right;">
2504.75
</td>
<td style="text-align:right;">
25
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
2500
</td>
<td style="text-align:right;">
4.75
</td>
</tr>
<tr>
<td style="text-align:right;">
4607.36
</td>
<td style="text-align:right;">
46
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
4600
</td>
<td style="text-align:right;">
7.36
</td>
</tr>
<tr>
<td style="text-align:right;">
3711.10
</td>
<td style="text-align:right;">
37
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
3700
</td>
<td style="text-align:right;">
11.10
</td>
</tr>
<tr>
<td style="text-align:right;">
3912.09
</td>
<td style="text-align:right;">
39
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
3900
</td>
<td style="text-align:right;">
12.09
</td>
</tr>
<tr>
<td style="text-align:right;">
2612.48
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
2600
</td>
<td style="text-align:right;">
12.48
</td>
</tr>
<tr>
<td style="text-align:right;">
4613.80
</td>
<td style="text-align:right;">
46
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
4600
</td>
<td style="text-align:right;">
13.80
</td>
</tr>
<tr>
<td style="text-align:right;">
4814.40
</td>
<td style="text-align:right;">
48
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
4800
</td>
<td style="text-align:right;">
14.40
</td>
</tr>
<tr>
<td style="text-align:right;">
2915.66
</td>
<td style="text-align:right;">
29
</td>
<td style="text-align:right;">
100
</td>
<td style="text-align:right;">
2900
</td>
<td style="text-align:right;">
15.66
</td>
</tr>
</tbody>
</table></div>
</div>
<p>If we plot the data, it looks like all of the errors are in one direction.</p>
<div class="sourceCode" id="cb289"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">errors</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">SALES</span>, y <span class="op">=</span> <span class="va">total</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_abline</span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15000</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">8000</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-wrangle_files/figure-html/unnamed-chunk-15-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>Let's have a look at the data separately for products with a price of exactly 100 versus other products.</p>
<div class="sourceCode" id="cb290"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sales_check</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>price100 <span class="op">=</span> <span class="va">price</span> <span class="op">==</span> <span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">SALES</span>, y <span class="op">=</span> <span class="va">total</span>, color <span class="op">=</span> <span class="va">price100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_abline</span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15000</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">8000</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-wrangle_files/figure-html/unnamed-chunk-16-1.png" width="100%" style="display: block; margin: auto;"></div>
<p>It looks like that's the problem with this dataset: the <code>PRICEEACH</code> column doesn't go above 100. Let's fix that by dividing the total sale price by the quantity ordered.</p>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fixed_sales</span> <span class="op">&lt;-</span> <span class="va">sales</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>PRICEEACH <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">SALES</span> <span class="op">/</span> <span class="va">QUANTITYORDERED</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now we can re-run the code from before to find any errors.</p>
<div class="sourceCode" id="cb292"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sales_check</span> <span class="op">&lt;-</span> <span class="va">fixed_sales</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">SALES</span>, n <span class="op">=</span> <span class="va">QUANTITYORDERED</span>, price <span class="op">=</span> <span class="va">PRICEEACH</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>total <span class="op">=</span> <span class="va">n</span> <span class="op">*</span> <span class="va">price</span><span class="op">)</span>

<span class="va">errors</span> <span class="op">&lt;-</span> <span class="va">sales_check</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">SALES</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">total</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">errors</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:right;">
SALES
</th>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
price
</th>
<th style="text-align:right;">
total
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
10172.7
</td>
<td style="text-align:right;">
47
</td>
<td style="text-align:right;">
216.44
</td>
<td style="text-align:right;">
10172.68
</td>
</tr>
<tr>
<td style="text-align:right;">
11623.7
</td>
<td style="text-align:right;">
48
</td>
<td style="text-align:right;">
242.16
</td>
<td style="text-align:right;">
11623.68
</td>
</tr>
<tr>
<td style="text-align:right;">
11739.7
</td>
<td style="text-align:right;">
76
</td>
<td style="text-align:right;">
154.47
</td>
<td style="text-align:right;">
11739.72
</td>
</tr>
<tr>
<td style="text-align:right;">
10039.6
</td>
<td style="text-align:right;">
43
</td>
<td style="text-align:right;">
233.48
</td>
<td style="text-align:right;">
10039.64
</td>
</tr>
<tr>
<td style="text-align:right;">
10066.6
</td>
<td style="text-align:right;">
46
</td>
<td style="text-align:right;">
218.84
</td>
<td style="text-align:right;">
10066.64
</td>
</tr>
</tbody>
</table></div>
</div>
<p>There are 5 instances where the quantity ordered doesn't divide into the total price in a way that produces prices that round to the nearest cent. These might require further investigation.</p>
</div>
<div id="glossary-wrangle" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> Glossary<a class="anchor" aria-label="anchor" href="#glossary-wrangle"><i class="fas fa-link"></i></a>
</h2>
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:left;">
definition
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
<a href="https://psyteachr.github.io/glossary/d.html#data-wrangling" class="glossary" target="_blank">data wrangling</a>
</td>
<td style="text-align:left;">
The process of preparing data for visualisation and statistical analysis.
</td>
</tr>
<tr>
<td style="text-align:left;">
<a href="https://psyteachr.github.io/glossary/f.html#factor" class="glossary" target="_blank">factor</a>
</td>
<td style="text-align:left;">
A data type where a specific set of values are stored with labels; An explanatory variable manipulated by the experimenter
</td>
</tr>
<tr>
<td style="text-align:left;">
<a href="https://psyteachr.github.io/glossary/m.html#match-operator" class="glossary" target="_blank">match operator</a>
</td>
<td style="text-align:left;">
A binary operator (%in%) that returns a logical vector indicating if there is a match or not for its left operand.
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="resources-wrangle" class="section level2" number="8.5">
<h2>
<span class="header-section-number">8.5</span> Further resources<a class="anchor" aria-label="anchor" href="#resources-wrangle"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><a href="https://raw.githubusercontent.com/rstudio/cheatsheets/main/data-transformation.pdf">Data transformation cheat sheet</a></li>
<li>
<a href="http://r4ds.had.co.nz/transform.html">Chapter 5: Data Transformation</a> in <em>R for Data Science</em>
</li>
</ul>
</div>
</div>
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  if (t = document.getElementById("webex-total_correct")) {
    var correct = document.getElementsByClassName("webex-correct").length;
    var solvemes = document.getElementsByClassName("webex-solveme").length;
    var radiogroups = document.getElementsByClassName("webex-radiogroup").length;
    var selects = document.getElementsByClassName("webex-select").length;

    t.innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;

  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    $(solveme[i]).after(" <span class='webex-icon'></span>");
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    $(selects[i]).after(" <span class='webex-icon'></span>");
  }

  update_total_correct();
}

</script><script>
$( document ).ready(function() {
  var cite = ' ';
  var psyteachr = ' <a href="https://psyteachr.github.io/"><img src="images/logos/psyteachr_logo.png" style="height: 31px; color: white;" alt="psyTeachR: Reproducible Research" /></a>';
  var license = ' <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/" target="blank"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"></a>';

  $("footer div.row div:eq(1) p").html(
    psyteachr + license + cite
  );

  function move_sidebar() {
    var w = window.innerWidth;
    if (w < 992) {
      $("#toc").appendTo($("#main-nav"));
    } else {
      $("#toc").appendTo($("div.sidebar-chapter"));
    }
  }
  move_sidebar();
  window.onresize = move_sidebar;
});
</script><div class="chapter-nav">
<div class="prev"><a href="tidy.html"><span class="header-section-number">7</span> Data Tidying</a></div>
<div class="next"><a href="custom.html"><span class="header-section-number">9</span> Customising Visualisations</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#wrangle"><span class="header-section-number">8</span> Data Wrangling</a></li>
<li><a class="nav-link" href="#ilo-wrangle"><span class="header-section-number">8.1</span> Intended Learning Outcomes</a></li>
<li>
<a class="nav-link" href="#wrangling-functions"><span class="header-section-number">8.2</span> Wrangling functions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#select"><span class="header-section-number">8.2.1</span> Select</a></li>
<li><a class="nav-link" href="#filter"><span class="header-section-number">8.2.2</span> Filter</a></li>
<li><a class="nav-link" href="#arrange"><span class="header-section-number">8.2.3</span> Arrange</a></li>
<li><a class="nav-link" href="#mutate"><span class="header-section-number">8.2.4</span> Mutate</a></li>
</ul>
</li>
<li><a class="nav-link" href="#together-wrangle"><span class="header-section-number">8.3</span> Putting it together</a></li>
<li><a class="nav-link" href="#glossary-wrangle"><span class="header-section-number">8.4</span> Glossary</a></li>
<li><a class="nav-link" href="#resources-wrangle"><span class="header-section-number">8.5</span> Further resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/psyteachr/ads-v1/blob/master/book/08-wrangle.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/psyteachr/ads-v1/edit/master/book/08-wrangle.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Applied Data Skills</strong>: Processing &amp; Presenting Data" was written by Emily Nordmann and Lisa DeBruine. It was last built on 2022-01-16.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
