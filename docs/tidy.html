<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Data Tidying | Applied Data Skills</title>
<meta name="author" content="Emily Nordmann and Lisa DeBruine">
<meta name="description" content="5.1 Intended Learning Outcomes Be able to change data between long and wide formats Separate, mutate, rename column headers and category labels Use pipes to chain together operations...">
<meta name="generator" content="bookdown 0.23 with bs4_book()">
<meta property="og:title" content="Chapter 5 Data Tidying | Applied Data Skills">
<meta property="og:type" content="book">
<meta property="og:url" content="https://psyteachr.github.io/ads-v1/tidy.html">
<meta property="og:image" content="https://psyteachr.github.io/ads-v1/images/logos/twitter_card.png">
<meta property="og:description" content="5.1 Intended Learning Outcomes Be able to change data between long and wide formats Separate, mutate, rename column headers and category labels Use pipes to chain together operations...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Data Tidying | Applied Data Skills">
<meta name="twitter:description" content="5.1 Intended Learning Outcomes Be able to change data between long and wide formats Separate, mutate, rename column headers and category labels Use pipes to chain together operations...">
<meta name="twitter:image" content="https://psyteachr.github.io/ads-v1/images/logos/twitter_card.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.9.4/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.1/tabs.js"></script><script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-6NP3MF25W3"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-6NP3MF25W3');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="include/psyteachr.css">
<link rel="stylesheet" href="include/webex.css">
<link rel="stylesheet" href="include/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Processing &amp; Presenting Data">Applied Data Skills</a>:
        <small class="text-muted">Processing &amp; Presenting Data</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Overview</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Intro to R, RStudio and R Markdown</a></li>
<li><a class="" href="reports.html"><span class="header-section-number">2</span> Reports with R Markdown</a></li>
<li><a class="" href="viz.html"><span class="header-section-number">3</span> Basic Data Visualisation</a></li>
<li><a class="" href="data.html"><span class="header-section-number">4</span> Data Import and Relations</a></li>
<li><a class="active" href="tidy.html"><span class="header-section-number">5</span> Data Tidying</a></li>
<li><a class="" href="wrangle.html"><span class="header-section-number">6</span> Data Wrangling</a></li>
<li><a class="" href="summary.html"><span class="header-section-number">7</span> Data Summaries</a></li>
<li><a class="" href="custom.html"><span class="header-section-number">8</span> Customising Visualisations</a></li>
<li><a class="" href="present.html"><span class="header-section-number">9</span> Dashboards, Reports, and Presentations</a></li>
<li><a class="" href="next.html"><span class="header-section-number">10</span> What's Next</a></li>
<li class="book-part">Appendices</li>
<li><a class="" href="installing-r.html"><span class="header-section-number">A</span> Installing R</a></li>
<li><a class="" href="symbols.html"><span class="header-section-number">B</span> Symbols</a></li>
<li><a class="" href="conventions.html"><span class="header-section-number">C</span> Conventions</a></li>
<li><a class="" href="data-types.html"><span class="header-section-number">D</span> Data Types</a></li>
<li><a class="" href="license.html">License</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/psyteachr/ads-v1">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="tidy" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Data Tidying<a class="anchor" aria-label="anchor" href="#tidy"><i class="fas fa-link"></i></a>
</h1>
<div id="ilo-tidy" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Intended Learning Outcomes<a class="anchor" aria-label="anchor" href="#ilo-tidy"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>Be able to change data between long and wide formats</li>
<li>Separate, mutate, rename column headers and category labels</li>
<li>Use pipes to chain together operations</li>
</ul>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="data-tidying" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Data Tidying<a class="anchor" aria-label="anchor" href="#data-tidying"><i class="fas fa-link"></i></a>
</h2>
<p>There are three rules for "tidy data":</p>
<ul>
<li>Each <a class="glossary" target="_blank" title="A word that identifies and stores the value of some data for later use." href="https://psyteachr.github.io/glossary/v#variable">variable</a> must have its own column</li>
<li>Each <a class="glossary" target="_blank" title="All of the data about a single trial or question." href="https://psyteachr.github.io/glossary/o#observation">observation</a> must have its own row</li>
<li>Each <a class="glossary" target="_blank" title="A single number or piece of data." href="https://psyteachr.github.io/glossary/v#value">value</a> must have its own cell</li>
</ul>
<div id="untidy-data" class="section level3" number="5.2.1">
<h3>
<span class="header-section-number">5.2.1</span> Untidy data<a class="anchor" aria-label="anchor" href="#untidy-data"><i class="fas fa-link"></i></a>
</h3>
<p>This table has three observations per row (2018, 2019, and 2020) and the <code>itemsprice_{year}</code> columns contain two values (number of items and price per item).</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:unnamed-chunk-1">Table 5.1: </span>Untidy table
</caption>
<thead><tr>
<th style="text-align:right;">
customer_id
</th>
<th style="text-align:left;">
itemsprice_2018
</th>
<th style="text-align:left;">
itemsprice_2019
</th>
<th style="text-align:left;">
itemsprice_2020
</th>
<th style="text-align:right;">
totalprice_2018
</th>
<th style="text-align:right;">
totalprice_2019
</th>
<th style="text-align:right;">
totalprice_2020
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
2 (3.91)
</td>
<td style="text-align:left;">
8 (4.72)
</td>
<td style="text-align:left;">
10 (5.59)
</td>
<td style="text-align:right;">
7.82
</td>
<td style="text-align:right;">
37.76
</td>
<td style="text-align:right;">
55.90
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
1 (3.91)
</td>
<td style="text-align:left;">
6 (4.72)
</td>
<td style="text-align:left;">
1 (5.59)
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
28.32
</td>
<td style="text-align:right;">
5.59
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
4 (3.91)
</td>
<td style="text-align:left;">
5 (4.72)
</td>
<td style="text-align:left;">
5 (5.59)
</td>
<td style="text-align:right;">
15.64
</td>
<td style="text-align:right;">
23.60
</td>
<td style="text-align:right;">
27.95
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
10 (3.91)
</td>
<td style="text-align:left;">
1 (4.72)
</td>
<td style="text-align:left;">
3 (5.59)
</td>
<td style="text-align:right;">
39.10
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
16.77
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
3 (3.91)
</td>
<td style="text-align:left;">
9 (4.72)
</td>
<td style="text-align:left;">
8 (5.59)
</td>
<td style="text-align:right;">
11.73
</td>
<td style="text-align:right;">
42.48
</td>
<td style="text-align:right;">
44.72
</td>
</tr>
</tbody>
</table></div>
<p>Let's say you wanted to calculate the total price per customer over the three years and the total number of items bought per customer. You can't perform mathematical operations on the <code>itemsprice_{year}</code> columns because they are <a class="glossary" target="_blank" title="A data type representing strings of text." href="https://psyteachr.github.io/glossary/c#character">character</a> <a class="glossary" target="_blank" title="The kind of data represented by an object." href="https://psyteachr.github.io/glossary/d#data-type">data types</a>.</p>
<p>You would probably normally use Excel to</p>
<ol style="list-style-type: decimal">
<li>split <code>itemsprice_2018</code> columns into <code>item_2018</code> and <code>price_2018</code> columns</li>
<li>split <code>itemsprice_2019</code> columns into <code>item_2019</code> and <code>price_2019</code> columns</li>
<li>split <code>itemsprice_2020</code> columns into <code>item_2018</code> and <code>price_2020</code> columns</li>
<li>add item_2018 + item_2019 + item_2020 to get the total number of items bought per customer</li>
<li>add totalprice_2018 + totalprice_2019 + totalprice_2020 to get the total price per customer</li>
</ol>
<div class="try">
<p>Think about how many steps in Excel this would be if there were 10 years in the table, or a different number of years each time you encountered data like this.</p>
</div>
</div>
<div id="tidy-data" class="section level3" number="5.2.2">
<h3>
<span class="header-section-number">5.2.2</span> Tidy data<a class="anchor" aria-label="anchor" href="#tidy-data"><i class="fas fa-link"></i></a>
</h3>
<p>This is the tidy version, where each row is a customer's orders in a particular year. The number of items (<code>items</code>) and price per item (<code>price_per_item</code>) are in separate columns, so now you can perform mathematical operations on them.</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:unnamed-chunk-1">Table 5.1: </span>Tidy table
</caption>
<thead><tr>
<th style="text-align:right;">
customer_id
</th>
<th style="text-align:right;">
year
</th>
<th style="text-align:right;">
items
</th>
<th style="text-align:right;">
price_per_item
</th>
<th style="text-align:right;">
totalprice
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
7.82
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2019
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
37.76
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
5.59
</td>
<td style="text-align:right;">
55.90
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
3.91
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2019
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
28.32
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
5.59
</td>
<td style="text-align:right;">
5.59
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
15.64
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2019
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
23.60
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
5.59
</td>
<td style="text-align:right;">
27.95
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
39.10
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
2019
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
4.72
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
5.59
</td>
<td style="text-align:right;">
16.77
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
11.73
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
2019
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
42.48
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
5.59
</td>
<td style="text-align:right;">
44.72
</td>
</tr>
</tbody>
</table></div>
<p>To calculate the total price per customer over the three years and the total number of items bought per customer in R, you would need to:</p>
<ol style="list-style-type: decimal">
<li>group the table by customer_id</li>
<li>sum the <code>items</code> column to get the total number of items bought per customer</li>
<li>sum the <code>totalprice</code> column to get the total price per customer</li>
</ol>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tidy_data</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"data/tidy_data.csv"</span><span class="op">)</span>

<span class="va">grouped_data</span> <span class="op">&lt;-</span> <span class="fu">group_by</span><span class="op">(</span>.data <span class="op">=</span> <span class="va">tidy_data</span>,
                         <span class="va">customer_id</span><span class="op">)</span>
<span class="fu">summarise</span><span class="op">(</span>
  .data <span class="op">=</span> <span class="va">grouped_data</span>,
  total_items <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">items</span><span class="op">)</span>,
  totalprice <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">totalprice</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:right;">
customer_id
</th>
<th style="text-align:right;">
total_items
</th>
<th style="text-align:right;">
totalprice
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
101.48
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
37.82
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
67.19
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
60.59
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
98.93
</td>
</tr>
</tbody>
</table></div>
</div>
<div class="info">
<p>If there were 10 years in the table, or a different number of years each time you encountered data like this, the code for producing the table above never changes.</p>
</div>
<p>If you have control over how the data are recorded, it will make your life easier to record it in a tidy format. However, we don't always have control, so this class will also teach you how to convert an untidy table into a tidy tables.</p>
</div>
</div>
<div id="reshaping-data" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Reshaping Data<a class="anchor" aria-label="anchor" href="#reshaping-data"><i class="fas fa-link"></i></a>
</h2>
<div id="too-many-observations-per-row" class="section level3" number="5.3.1">
<h3>
<span class="header-section-number">5.3.1</span> Too many observations per row<a class="anchor" aria-label="anchor" href="#too-many-observations-per-row"><i class="fas fa-link"></i></a>
</h3>
<p>Data tables can be in <a class="glossary" target="_blank" title="Data where all of the observations about one subject are in the same row" href="https://psyteachr.github.io/glossary/w#wide">wide</a> format or <a class="glossary" target="_blank" title="Data where each observation is on a separate row" href="https://psyteachr.github.io/glossary/l#long">long</a> format (and sometimes a mix of the two). Wide data are where all of the observations about one thing are in the same row, while long data are where each observation is on a separate row. You often need to convert between these formats to do different types of summaries or visualisation.</p>
<p>Let's look again at just the <code>totalprice</code> data from the untidy table above. We can select just the columns we want using the <code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::select()</a></code> function. This function's first argument is the data table you want to select from, then each argument after that is either the name of a column in that table, or <code>new_name = old_name</code>. This is a useful function for changing the column names and order of columns, as well as selecting a subset of columns.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># select just the customer ID and 3 total price columns</span>
<span class="va">untidy_price</span> <span class="op">&lt;-</span> <span class="fu">select</span><span class="op">(</span>
  .data <span class="op">=</span> <span class="va">untidy_data</span>,
  <span class="va">customer_id</span>, 
  `2018` <span class="op">=</span> <span class="va">totalprice_2018</span>,
  `2019` <span class="op">=</span> <span class="va">totalprice_2019</span>,
  `2020` <span class="op">=</span> <span class="va">totalprice_2020</span>
<span class="op">)</span></code></pre></div>
<p>This is in wide format, where each row is a customer, and represents the data from several years. This is a really intuitive way for humans to read a table, but it's not as easy for a computer to process it.</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:wide-data">Table 5.2: </span>Wide data
</caption>
<thead><tr>
<th style="text-align:right;">
customer_id
</th>
<th style="text-align:right;">
2018
</th>
<th style="text-align:right;">
2019
</th>
<th style="text-align:right;">
2020
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
7.82
</td>
<td style="text-align:right;">
37.76
</td>
<td style="text-align:right;">
55.90
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
28.32
</td>
<td style="text-align:right;">
5.59
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
15.64
</td>
<td style="text-align:right;">
23.60
</td>
<td style="text-align:right;">
27.95
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
39.10
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
16.77
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
11.73
</td>
<td style="text-align:right;">
42.48
</td>
<td style="text-align:right;">
44.72
</td>
</tr>
</tbody>
</table></div>
<p>The same data can be represented in a long format by creating a new column that specifies what <code>item</code> the observation is from and a new column that specifies the <code>value</code> of that observation. This is easier to use to make summaries and plots.</p>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:long-data">Table 5.3: </span>Long data
</caption>
<thead><tr>
<th style="text-align:right;">
customer_id
</th>
<th style="text-align:left;">
year
</th>
<th style="text-align:right;">
totalprice
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
2018
</td>
<td style="text-align:right;">
7.82
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
2018
</td>
<td style="text-align:right;">
3.91
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2018
</td>
<td style="text-align:right;">
15.64
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
2018
</td>
<td style="text-align:right;">
39.10
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
2018
</td>
<td style="text-align:right;">
11.73
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
2019
</td>
<td style="text-align:right;">
37.76
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
2019
</td>
<td style="text-align:right;">
28.32
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2019
</td>
<td style="text-align:right;">
23.60
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
2019
</td>
<td style="text-align:right;">
4.72
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
2019
</td>
<td style="text-align:right;">
42.48
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
2020
</td>
<td style="text-align:right;">
55.90
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
2020
</td>
<td style="text-align:right;">
5.59
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
2020
</td>
<td style="text-align:right;">
27.95
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
2020
</td>
<td style="text-align:right;">
16.77
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
2020
</td>
<td style="text-align:right;">
44.72
</td>
</tr>
</tbody>
</table></div>
<div class="try">
<p>Create a long version of the following table. You don't need to use code, just sketch it in a notebook or make a table in a spreadsheet.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="left">id</th>
<th align="left">twitter_followers</th>
<th align="left">instagram_followers</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Emily</td>
<td align="left">3487</td>
<td align="left">120</td>
</tr>
<tr class="even">
<td align="left">Lisa</td>
<td align="left">9110</td>
<td align="left">110</td>
</tr>
</tbody>
</table></div>
<div class="webex-solution">
<button>
Answer
</button>
<p>Your answer doesn't need to have the same column headers or be in the same order.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="left">id</th>
<th align="left">social_media</th>
<th align="left">followers</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Emily</td>
<td align="left">twitter</td>
<td align="left">3487</td>
</tr>
<tr class="even">
<td align="left">Emily</td>
<td align="left">instagram</td>
<td align="left">120</td>
</tr>
<tr class="odd">
<td align="left">Lisa</td>
<td align="left">twitter</td>
<td align="left">9110</td>
</tr>
<tr class="even">
<td align="left">Lisa</td>
<td align="left">instagram</td>
<td align="left">110</td>
</tr>
</tbody>
</table></div>
</div>
</div>
<p>The pivot functions allow you to transform a data table from wide to long or long to wide.</p>
<div id="wide-to-long" class="section level4" number="5.3.1.1">
<h4>
<span class="header-section-number">5.3.1.1</span> Wide to long<a class="anchor" aria-label="anchor" href="#wide-to-long"><i class="fas fa-link"></i></a>
</h4>
<p>The function <code>pivot_longer()</code> converts a wide data table to a longer format by converting the headers from specified columns into the values of new columns, and combining the values of those columns into a new condensed column.</p>
<p>This function has several arguments:</p>
<ul>
<li>
<code>cols</code>: the columns you want to make long You can refer to them by their names, like <code>col1, col2, col3, col4</code> or <code>col1:col4</code> or by their numbers, like <code>8, 9, 10</code> or <code>8:10</code>.</li>
<li>
<code>names_to</code>: what you want to call the new columns that the gathered column headers will go into; it's "domain" and "qnumber" in this example.</li>
<li>
<code>names_sep</code>: an optional argument if you have more than one value for <code>names_to</code>. It specifies the characters or position to split the values of the <code>cols</code> headers.</li>
<li>
<code>values_to</code>: what you want to call the values in the columns <code>...</code>; they're "score" in this example.</li>
</ul>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">untidy_price_long</span> <span class="op">&lt;-</span> <span class="fu">pivot_longer</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">untidy_price</span>, 
  cols <span class="op">=</span> <span class="va">`2018`</span><span class="op">:</span><span class="va">`2020`</span>, <span class="co"># columns to make long </span>
  names_to <span class="op">=</span> <span class="st">"year"</span>, <span class="co"># new column name for headers</span>
  values_to <span class="op">=</span> <span class="st">"totalprice"</span> <span class="co"># new column name for values</span>
<span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 15 x 3
##    customer_id year  totalprice
##          &lt;int&gt; &lt;chr&gt;      &lt;dbl&gt;
##  1           1 2018        7.82
##  2           1 2019       37.8 
##  3           1 2020       55.9 
##  4           2 2018        3.91
##  5           2 2019       28.3 
##  6           2 2020        5.59
##  7           3 2018       15.6 
##  8           3 2019       23.6 
##  9           3 2020       28.0 
## 10           4 2018       39.1 
## 11           4 2019        4.72
## 12           4 2020       16.8 
## 13           5 2018       11.7 
## 14           5 2019       42.5 
## 15           5 2020       44.7</code></pre>
</div>
<div id="long-to-wide" class="section level4" number="5.3.1.2">
<h4>
<span class="header-section-number">5.3.1.2</span> Long to wide<a class="anchor" aria-label="anchor" href="#long-to-wide"><i class="fas fa-link"></i></a>
</h4>
<p>We can also go from long to wide format using the <code>pivot_wider()</code> function.</p>
<ul>
<li>
<code>names_from</code>: the columns that contain your new column headers.</li>
<li>
<code>values_from</code>: the column that contains the values for the new columns.</li>
<li>
<code>names_sep</code>:the character string used to join names if <code>names_from</code> is more than one column.</li>
</ul>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">untidy_price_wide</span> <span class="op">&lt;-</span> <span class="fu">pivot_wider</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">untidy_price_long</span>,
  names_from <span class="op">=</span> <span class="va">year</span>,
  values_from <span class="op">=</span> <span class="va">totalprice</span>
<span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 5 x 4
##   customer_id `2018` `2019` `2020`
##         &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1           1   7.82  37.8   55.9 
## 2           2   3.91  28.3    5.59
## 3           3  15.6   23.6   28.0 
## 4           4  39.1    4.72  16.8 
## 5           5  11.7   42.5   44.7</code></pre>
</div>
<div id="multi-step-tidying" class="section level4" number="5.3.1.3">
<h4>
<span class="header-section-number">5.3.1.3</span> Multi-step tidying<a class="anchor" aria-label="anchor" href="#multi-step-tidying"><i class="fas fa-link"></i></a>
</h4>
<p>You often need to go from wide, to long, to an intermediate shape in order to get your data into a format that is useful for plotting, where there is a column for each type of data that you want to represent with an aesthetic.</p>
<p>Our full <code>untidy_data</code> table has seven columns: a customer ID, three columns for <code>itemsprice</code> and 3 columns for <code>totalprice</code>.</p>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:right;">
customer_id
</th>
<th style="text-align:left;">
itemsprice_2018
</th>
<th style="text-align:left;">
itemsprice_2019
</th>
<th style="text-align:left;">
itemsprice_2020
</th>
<th style="text-align:right;">
totalprice_2018
</th>
<th style="text-align:right;">
totalprice_2019
</th>
<th style="text-align:right;">
totalprice_2020
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
2 (3.91)
</td>
<td style="text-align:left;">
8 (4.72)
</td>
<td style="text-align:left;">
10 (5.59)
</td>
<td style="text-align:right;">
7.82
</td>
<td style="text-align:right;">
37.76
</td>
<td style="text-align:right;">
55.90
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
1 (3.91)
</td>
<td style="text-align:left;">
6 (4.72)
</td>
<td style="text-align:left;">
1 (5.59)
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
28.32
</td>
<td style="text-align:right;">
5.59
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
4 (3.91)
</td>
<td style="text-align:left;">
5 (4.72)
</td>
<td style="text-align:left;">
5 (5.59)
</td>
<td style="text-align:right;">
15.64
</td>
<td style="text-align:right;">
23.60
</td>
<td style="text-align:right;">
27.95
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
10 (3.91)
</td>
<td style="text-align:left;">
1 (4.72)
</td>
<td style="text-align:left;">
3 (5.59)
</td>
<td style="text-align:right;">
39.10
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
16.77
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
3 (3.91)
</td>
<td style="text-align:left;">
9 (4.72)
</td>
<td style="text-align:left;">
8 (5.59)
</td>
<td style="text-align:right;">
11.73
</td>
<td style="text-align:right;">
42.48
</td>
<td style="text-align:right;">
44.72
</td>
</tr>
</tbody>
</table></div>
</div>
<p>We want to get it into the tidy format where each row is an observation of one customer per year, with the columns of <code>customer_id</code>, <code>year</code>, <code>item</code>, <code>price_per_item</code> and <code>totalprice</code>.</p>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr>
<th style="text-align:right;">
customer_id
</th>
<th style="text-align:right;">
year
</th>
<th style="text-align:right;">
items
</th>
<th style="text-align:right;">
price_per_item
</th>
<th style="text-align:right;">
totalprice
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
7.82
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2019
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
37.76
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
5.59
</td>
<td style="text-align:right;">
55.90
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
3.91
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2019
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
28.32
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
5.59
</td>
<td style="text-align:right;">
5.59
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
15.64
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2019
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
23.60
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
5.59
</td>
<td style="text-align:right;">
27.95
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
39.10
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
2019
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
4.72
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
5.59
</td>
<td style="text-align:right;">
16.77
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
2018
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
3.91
</td>
<td style="text-align:right;">
11.73
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
2019
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
4.72
</td>
<td style="text-align:right;">
42.48
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
5.59
</td>
<td style="text-align:right;">
44.72
</td>
</tr>
</tbody>
</table></div>
</div>
<p>First we start by making the table super-long. Because we'll be combining columns with numeric and character data type, we need to make the new <code>value</code> column a character data type using <code>values_transform</code>, since numbers can be represented as characters (like <code><span class="st">"3.5"</span></code>), but character strings can't be represented as numbers.</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">longer_data</span> <span class="op">&lt;-</span> <span class="fu">pivot_longer</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">untidy_data</span>, 
  cols <span class="op">=</span> <span class="va">itemsprice_2018</span><span class="op">:</span><span class="va">totalprice_2020</span>, <span class="co"># columns to make long </span>
  names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"category"</span>, <span class="st">"year"</span><span class="op">)</span>,       <span class="co"># new column names for cols</span>
  names_sep <span class="op">=</span> <span class="st">"_"</span>,                        <span class="co"># how to split cols into new columns</span>
  <span class="co"># names_pattern = "(.*)_(.*)", # alternative to names_sep</span>
  values_to <span class="op">=</span> <span class="st">"value"</span>, <span class="co"># new column name for values</span>
  
  <span class="co"># make sure new columns are the right data type</span>
  names_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span>,
  values_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">as.character</span><span class="op">)</span> 
<span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 30 x 4
##    customer_id category    year value    
##          &lt;int&gt; &lt;chr&gt;      &lt;int&gt; &lt;chr&gt;    
##  1           1 itemsprice  2018 2 (3.91) 
##  2           1 itemsprice  2019 8 (4.72) 
##  3           1 itemsprice  2020 10 (5.59)
##  4           1 totalprice  2018 7.82     
##  5           1 totalprice  2019 37.76    
##  6           1 totalprice  2020 55.9     
##  7           2 itemsprice  2018 1 (3.91) 
##  8           2 itemsprice  2019 6 (4.72) 
##  9           2 itemsprice  2020 1 (5.59) 
## 10           2 totalprice  2018 3.91     
## # … with 20 more rows</code></pre>
<p>Now we need to make the table wider, but not as wide as before. We want to keep the <code>year</code> column and make new columns called <code>itemsprice</code> and <code>totalprice</code> with the relevant customer's <code>value</code> for that category and year.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wider_data</span> <span class="op">&lt;-</span> <span class="fu">pivot_wider</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">longer_data</span>,
  id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">customer_id</span>, <span class="va">year</span><span class="op">)</span>,
  names_from <span class="op">=</span> <span class="va">category</span>,
  values_from <span class="op">=</span> <span class="va">value</span>
<span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 15 x 4
##    customer_id  year itemsprice totalprice
##          &lt;int&gt; &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;     
##  1           1  2018 2 (3.91)   7.82      
##  2           1  2019 8 (4.72)   37.76     
##  3           1  2020 10 (5.59)  55.9      
##  4           2  2018 1 (3.91)   3.91      
##  5           2  2019 6 (4.72)   28.32     
##  6           2  2020 1 (5.59)   5.59      
##  7           3  2018 4 (3.91)   15.64     
##  8           3  2019 5 (4.72)   23.6      
##  9           3  2020 5 (5.59)   27.95     
## 10           4  2018 10 (3.91)  39.1      
## 11           4  2019 1 (4.72)   4.72      
## 12           4  2020 3 (5.59)   16.77     
## 13           5  2018 3 (3.91)   11.73     
## 14           5  2019 9 (4.72)   42.48     
## 15           5  2020 8 (5.59)   44.72</code></pre>
</div>
</div>
<div id="too-many-variables-per-column" class="section level3" number="5.3.2">
<h3>
<span class="header-section-number">5.3.2</span> Too many variables per column<a class="anchor" aria-label="anchor" href="#too-many-variables-per-column"><i class="fas fa-link"></i></a>
</h3>
<p>Notice that the <code>itemsprice</code> and <code>totalprice</code> columns are characters, not numeric types. This happens any time you have non-numeric characters in a column, like parentheses, or when you put numeric and character data together in a column.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">glimpse</span><span class="op">(</span><span class="va">wider_data</span><span class="op">)</span></code></pre></div>
<pre><code>## Rows: 15
## Columns: 4
## $ customer_id &lt;int&gt; 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5
## $ year        &lt;int&gt; 2018, 2019, 2020, 2018, 2019, 2020, 2018, 2019, 2020, 2018…
## $ itemsprice  &lt;chr&gt; "2 (3.91)", "8 (4.72)", "10 (5.59)", "1 (3.91)", "6 (4.72)…
## $ totalprice  &lt;chr&gt; "7.82", "37.76", "55.9", "3.91", "28.32", "5.59", "15.64",…</code></pre>
<p>What we want to do is to split the <code>itemsprice</code> column into two columns, <code>items</code>, and <code>price_per_item</code>.</p>
<p>You can split a column into parts with the function <code><a href="https://tidyr.tidyverse.org/reference/separate.html">tidyr::separate()</a></code>.</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">split_data</span> <span class="op">&lt;-</span> <span class="fu">separate</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">wider_data</span>, 
  col <span class="op">=</span> <span class="va">itemsprice</span>, <span class="co"># the column to split</span>
  into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"items"</span>, <span class="st">"price_per_item"</span><span class="op">)</span>, <span class="co"># the new columns to create</span>
  sep <span class="op">=</span> <span class="st">" "</span>, <span class="co"># how to split col</span>
  remove <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># whether to remove to old col</span>
  convert <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># whether to fix the data type of the new columns</span>
<span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 15 x 5
##    customer_id  year items price_per_item totalprice
##          &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;          &lt;chr&gt;     
##  1           1  2018     2 (3.91)         7.82      
##  2           1  2019     8 (4.72)         37.76     
##  3           1  2020    10 (5.59)         55.9      
##  4           2  2018     1 (3.91)         3.91      
##  5           2  2019     6 (4.72)         28.32     
##  6           2  2020     1 (5.59)         5.59      
##  7           3  2018     4 (3.91)         15.64     
##  8           3  2019     5 (4.72)         23.6      
##  9           3  2020     5 (5.59)         27.95     
## 10           4  2018    10 (3.91)         39.1      
## 11           4  2019     1 (4.72)         4.72      
## 12           4  2020     3 (5.59)         16.77     
## 13           5  2018     3 (3.91)         11.73     
## 14           5  2019     9 (4.72)         42.48     
## 15           5  2020     8 (5.59)         44.72</code></pre>
</div>
<div id="changing-data" class="section level3" number="5.3.3">
<h3>
<span class="header-section-number">5.3.3</span> Changing data<a class="anchor" aria-label="anchor" href="#changing-data"><i class="fas fa-link"></i></a>
</h3>
<p>The column <code>price_per_item</code> is still a character column because it has parentheses. There are a few ways to fix this. You can use the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> function to change a column or add a new one.</p>
<p>Here, we'll use <code><a href="https://stringr.tidyverse.org/reference/str_replace.html">stringr::str_replace_all()</a></code> to replace all of the "(" and ")" with "".</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fixed_data</span> <span class="op">&lt;-</span> <span class="fu">mutate</span><span class="op">(</span>
  .data <span class="op">=</span> <span class="va">split_data</span>,
  price_per_item <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span>
    string <span class="op">=</span> <span class="va">price_per_item</span>, 
    pattern <span class="op">=</span> <span class="st">"[()]"</span>, 
    replacement <span class="op">=</span> <span class="st">""</span>
  <span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 15 x 5
##    customer_id  year items price_per_item totalprice
##          &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;          &lt;chr&gt;     
##  1           1  2018     2 3.91           7.82      
##  2           1  2019     8 4.72           37.76     
##  3           1  2020    10 5.59           55.9      
##  4           2  2018     1 3.91           3.91      
##  5           2  2019     6 4.72           28.32     
##  6           2  2020     1 5.59           5.59      
##  7           3  2018     4 3.91           15.64     
##  8           3  2019     5 4.72           23.6      
##  9           3  2020     5 5.59           27.95     
## 10           4  2018    10 3.91           39.1      
## 11           4  2019     1 4.72           4.72      
## 12           4  2020     3 5.59           16.77     
## 13           5  2018     3 3.91           11.73     
## 14           5  2019     9 4.72           42.48     
## 15           5  2020     8 5.59           44.72</code></pre>
</div>
<div id="fixing-data-types" class="section level3" number="5.3.4">
<h3>
<span class="header-section-number">5.3.4</span> Fixing data types<a class="anchor" aria-label="anchor" href="#fixing-data-types"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>price_per_item</code> and <code>totalprice</code> columns are still characters. You can fix all of your column data types in one step, once the data are clean and tidy.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tidy_data</span> <span class="op">&lt;-</span> <span class="fu">type_convert</span><span class="op">(</span>
  df <span class="op">=</span> <span class="va">fixed_data</span>,
  trim_ws <span class="op">=</span> <span class="cn">TRUE</span>,
<span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 15 x 5
##    customer_id  year items price_per_item totalprice
##          &lt;int&gt; &lt;int&gt; &lt;int&gt;          &lt;dbl&gt;      &lt;dbl&gt;
##  1           1  2018     2           3.91       7.82
##  2           1  2019     8           4.72      37.8 
##  3           1  2020    10           5.59      55.9 
##  4           2  2018     1           3.91       3.91
##  5           2  2019     6           4.72      28.3 
##  6           2  2020     1           5.59       5.59
##  7           3  2018     4           3.91      15.6 
##  8           3  2019     5           4.72      23.6 
##  9           3  2020     5           5.59      28.0 
## 10           4  2018    10           3.91      39.1 
## 11           4  2019     1           4.72       4.72
## 12           4  2020     3           5.59      16.8 
## 13           5  2018     3           3.91      11.7 
## 14           5  2019     9           4.72      42.5 
## 15           5  2020     8           5.59      44.7</code></pre>
</div>
</div>
<div id="pipes" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> Pipes<a class="anchor" aria-label="anchor" href="#pipes"><i class="fas fa-link"></i></a>
</h2>
<div style="width: 200px; float: right;">
<img src="images/pipe_sticker.png" style="width: 100%">
</div>
<p>Pipes are a way to order your code in a more readable format.</p>
<p>You can always create a new object at every step and use that object in the next step, like we did above. This is pretty clear, but you've created several unnecessary data objects in your environment. This can get confusing in very long scripts.</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">untidy_data</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span>file <span class="op">=</span> <span class="st">"data/untidy_data.csv"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   customer_id = col_double(),
##   itemsprice_2018 = col_character(),
##   itemsprice_2019 = col_character(),
##   itemsprice_2020 = col_character(),
##   totalprice_2018 = col_double(),
##   totalprice_2019 = col_double(),
##   totalprice_2020 = col_double()
## )</code></pre>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">longer_data</span> <span class="op">&lt;-</span> <span class="fu">pivot_longer</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">untidy_data</span>,
  cols <span class="op">=</span> <span class="va">itemsprice_2018</span><span class="op">:</span><span class="va">totalprice_2020</span>,
  names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"category"</span>, <span class="st">"year"</span><span class="op">)</span>,
  names_sep <span class="op">=</span> <span class="st">"_"</span>, 
  values_to <span class="op">=</span> <span class="st">"value"</span>, 
  names_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span>,
  values_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">as.character</span><span class="op">)</span> 
<span class="op">)</span> 

<span class="va">wider_data</span> <span class="op">&lt;-</span> <span class="fu">pivot_wider</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">longer_data</span>,
  id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">customer_id</span>, <span class="va">year</span><span class="op">)</span>,
  names_from <span class="op">=</span> <span class="va">category</span>,
  values_from <span class="op">=</span> <span class="va">value</span>
<span class="op">)</span>

<span class="va">split_data</span> <span class="op">&lt;-</span> <span class="fu">separate</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">wider_data</span>,
  col <span class="op">=</span> <span class="va">itemsprice</span>,
  into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"items"</span>, <span class="st">"price_per_item"</span><span class="op">)</span>,
  sep <span class="op">=</span> <span class="st">" "</span>, 
  remove <span class="op">=</span> <span class="cn">TRUE</span>, 
  convert <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span> 

<span class="va">fixed_data</span> <span class="op">&lt;-</span> <span class="fu">mutate</span><span class="op">(</span>
  .data <span class="op">=</span> <span class="va">split_data</span>,
  price_per_item <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span>
    string <span class="op">=</span> <span class="va">price_per_item</span>, 
    pattern <span class="op">=</span> <span class="st">"[()]"</span>, 
    replacement <span class="op">=</span> <span class="st">""</span>
  <span class="op">)</span>
<span class="op">)</span> 

<span class="va">tidy_data</span> <span class="op">&lt;-</span> <span class="fu">type_convert</span><span class="op">(</span>
  df <span class="op">=</span> <span class="va">fixed_data</span>,
  trim_ws <span class="op">=</span> <span class="cn">TRUE</span>,
<span class="op">)</span></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   price_per_item = col_double(),
##   totalprice = col_double()
## )</code></pre>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tidy_data</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 15 x 5
##    customer_id  year items price_per_item totalprice
##          &lt;dbl&gt; &lt;int&gt; &lt;int&gt;          &lt;dbl&gt;      &lt;dbl&gt;
##  1           1  2018     2           3.91       7.82
##  2           1  2019     8           4.72      37.8 
##  3           1  2020    10           5.59      55.9 
##  4           2  2018     1           3.91       3.91
##  5           2  2019     6           4.72      28.3 
##  6           2  2020     1           5.59       5.59
##  7           3  2018     4           3.91      15.6 
##  8           3  2019     5           4.72      23.6 
##  9           3  2020     5           5.59      28.0 
## 10           4  2018    10           3.91      39.1 
## 11           4  2019     1           4.72       4.72
## 12           4  2020     3           5.59      16.8 
## 13           5  2018     3           3.91      11.7 
## 14           5  2019     9           4.72      42.5 
## 15           5  2020     8           5.59      44.7</code></pre>
<div class="warning">
<p>You <em>can</em> name each object <code>data</code> and keep replacing the old data object with the new one at each step. This will keep your environment clean, but I don't recommend it because it makes it too easy to accidentally run your code out of order when you are running line-by-line for development or debugging.</p>
</div>
<p>One way to avoid extra objects is to nest your functions, literally replacing each data object with the code that generated it in the previous step. This can be fine for very short chains.</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mean_petal_width</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Petal.Width</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>But it gets extremely confusing for long chains:</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># do not ever do this!!!!!!</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu">type_convert</span><span class="op">(</span>
  df <span class="op">=</span> <span class="fu">mutate</span><span class="op">(</span>
    .data <span class="op">=</span> <span class="fu">separate</span><span class="op">(</span>
      data <span class="op">=</span> <span class="fu">pivot_wider</span><span class="op">(</span>
        data <span class="op">=</span> <span class="fu">pivot_longer</span><span class="op">(</span>
          data <span class="op">=</span> <span class="fu">read_csv</span><span class="op">(</span>file <span class="op">=</span> <span class="st">"data/untidy_data.csv"</span><span class="op">)</span>,
          cols <span class="op">=</span> <span class="va">itemsprice_2018</span><span class="op">:</span><span class="va">totalprice_2020</span>,
          names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"category"</span>, <span class="st">"year"</span><span class="op">)</span>,
          names_sep <span class="op">=</span> <span class="st">"_"</span>,
          values_to <span class="op">=</span> <span class="st">"value"</span>,
          names_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span>,
          values_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">as.character</span><span class="op">)</span>
        <span class="op">)</span> ,
        id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">customer_id</span>, <span class="va">year</span><span class="op">)</span>,
        names_from <span class="op">=</span> <span class="va">category</span>,
        values_from <span class="op">=</span> <span class="va">value</span>
      <span class="op">)</span>,
      col <span class="op">=</span> <span class="va">itemsprice</span>,
      into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"items"</span>, <span class="st">"price_per_item"</span><span class="op">)</span>,
      sep <span class="op">=</span> <span class="st">" "</span>,
      remove <span class="op">=</span> <span class="cn">TRUE</span>,
      convert <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span> ,
    price_per_item <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span>
      string <span class="op">=</span> <span class="va">price_per_item</span>,
      pattern <span class="op">=</span> <span class="st">"[()]"</span>,
      replacement <span class="op">=</span> <span class="st">""</span>
    <span class="op">)</span>
  <span class="op">)</span>,
  trim_ws <span class="op">=</span> <span class="cn">TRUE</span>,
<span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   customer_id = col_double(),
##   itemsprice_2018 = col_character(),
##   itemsprice_2019 = col_character(),
##   itemsprice_2020 = col_character(),
##   totalprice_2018 = col_double(),
##   totalprice_2019 = col_double(),
##   totalprice_2020 = col_double()
## )</code></pre>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   price_per_item = col_double(),
##   totalprice = col_double()
## )</code></pre>
<pre><code>## # A tibble: 15 x 5
##    customer_id  year items price_per_item totalprice
##          &lt;dbl&gt; &lt;int&gt; &lt;int&gt;          &lt;dbl&gt;      &lt;dbl&gt;
##  1           1  2018     2           3.91       7.82
##  2           1  2019     8           4.72      37.8 
##  3           1  2020    10           5.59      55.9 
##  4           2  2018     1           3.91       3.91
##  5           2  2019     6           4.72      28.3 
##  6           2  2020     1           5.59       5.59
##  7           3  2018     4           3.91      15.6 
##  8           3  2019     5           4.72      23.6 
##  9           3  2020     5           5.59      28.0 
## 10           4  2018    10           3.91      39.1 
## 11           4  2019     1           4.72       4.72
## 12           4  2020     3           5.59      16.8 
## 13           5  2018     3           3.91      11.7 
## 14           5  2019     9           4.72      42.5 
## 15           5  2020     8           5.59      44.7</code></pre>
<p>The pipe lets you "pipe" the result of each function into the next function, allowing you to put your code in a logical order without creating too many extra objects.</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tidy_data</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span>file <span class="op">=</span> <span class="st">"data/untidy_data.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span>
    cols <span class="op">=</span> <span class="va">itemsprice_2018</span><span class="op">:</span><span class="va">totalprice_2020</span>,
    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"category"</span>, <span class="st">"year"</span><span class="op">)</span>,
    names_sep <span class="op">=</span> <span class="st">"_"</span>, 
    values_to <span class="op">=</span> <span class="st">"value"</span>, 
    names_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span>,
    values_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">as.character</span><span class="op">)</span> 
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_wider</span><span class="op">(</span>
    id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">customer_id</span>, <span class="va">year</span><span class="op">)</span>,
    names_from <span class="op">=</span> <span class="va">category</span>,
    values_from <span class="op">=</span> <span class="va">value</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">separate</span><span class="op">(</span>
    col <span class="op">=</span> <span class="va">itemsprice</span>,
    into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"items"</span>, <span class="st">"price_per_item"</span><span class="op">)</span>,
    sep <span class="op">=</span> <span class="st">" "</span>, 
    remove <span class="op">=</span> <span class="cn">TRUE</span>, 
    convert <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    price_per_item <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span>
      string <span class="op">=</span> <span class="va">price_per_item</span>, 
      pattern <span class="op">=</span> <span class="st">"[()]"</span>, 
      replacement <span class="op">=</span> <span class="st">""</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">type_convert</span><span class="op">(</span>
    trim_ws <span class="op">=</span> <span class="cn">TRUE</span>,
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   customer_id = col_double(),
##   itemsprice_2018 = col_character(),
##   itemsprice_2019 = col_character(),
##   itemsprice_2020 = col_character(),
##   totalprice_2018 = col_double(),
##   totalprice_2019 = col_double(),
##   totalprice_2020 = col_double()
## )</code></pre>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   price_per_item = col_double(),
##   totalprice = col_double()
## )</code></pre>
<pre><code>## # A tibble: 15 x 5
##    customer_id  year items price_per_item totalprice
##          &lt;dbl&gt; &lt;int&gt; &lt;int&gt;          &lt;dbl&gt;      &lt;dbl&gt;
##  1           1  2018     2           3.91       7.82
##  2           1  2019     8           4.72      37.8 
##  3           1  2020    10           5.59      55.9 
##  4           2  2018     1           3.91       3.91
##  5           2  2019     6           4.72      28.3 
##  6           2  2020     1           5.59       5.59
##  7           3  2018     4           3.91      15.6 
##  8           3  2019     5           4.72      23.6 
##  9           3  2020     5           5.59      28.0 
## 10           4  2018    10           3.91      39.1 
## 11           4  2019     1           4.72       4.72
## 12           4  2020     3           5.59      16.8 
## 13           5  2018     3           3.91      11.7 
## 14           5  2019     9           4.72      42.5 
## 15           5  2020     8           5.59      44.7</code></pre>
<p>You can make intermediate objects whenever you need to break up your code because it's getting too complicated or if you need to debug something.</p>
<div class="info">
<p>You can debug a pipe by highlighting from the beginning to just before the pipe you want to stop at. Try this by highlighting from <code>data &lt;-</code> to the end of the <code>separate</code> function and typing cmd-return. What does <code>data</code> look like now?</p>
</div>
</div>
<div id="exercise" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> Exercise<a class="anchor" aria-label="anchor" href="#exercise"><i class="fas fa-link"></i></a>
</h2>
<p>Let's say you have a <a href="data/widgets_gadgets.xlsx">small Excel table</a> with 10 customer IDs, and how many widgets and gadgets each purchased in 2020 and 2021.</p>
<p>You want to calculate the total number of items purchased per year make a table sorted by the total number of items purchased.</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># get the data with better column names</span>
<span class="va">data_original</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span>
  path <span class="op">=</span> <span class="st">"data/widgets_gadgets.xlsx"</span>, 
  skip <span class="op">=</span> <span class="fl">2</span>,
  col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"customer_id"</span>, 
                <span class="st">"widgets_2020"</span>, 
                <span class="st">"widgets_2021"</span>, 
                <span class="st">"gadgets_2020"</span>, 
                <span class="st">"gadgets_2021"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># gather columns 2 to 5 into "item_year" and "number" columns</span>
<span class="va">data_gathered</span> <span class="op">&lt;-</span> <span class="fu">gather</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_original</span>, 
                        key <span class="op">=</span> <span class="va">item_year</span>, 
                        value <span class="op">=</span> <span class="va">number</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>

<span class="co"># separate the item_year column at the _ into "item" and "year" columns</span>
<span class="va">data_separated</span> <span class="op">&lt;-</span> <span class="fu">separate</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_gathered</span>, 
                           col <span class="op">=</span> <span class="va">item_year</span>, 
                           into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"item"</span>, <span class="st">"year"</span><span class="op">)</span>, 
                           sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>

<span class="co"># group the data by item and year</span>
<span class="va">data_grouped</span> <span class="op">&lt;-</span> <span class="fu">group_by</span><span class="op">(</span>.data <span class="op">=</span> <span class="va">data_separated</span>, <span class="va">item</span>, <span class="va">year</span><span class="op">)</span>

<span class="co"># calculate the total number for each item/year </span>
<span class="va">data_summarised</span> <span class="op">&lt;-</span> <span class="fu">summarise</span><span class="op">(</span>.data <span class="op">=</span> <span class="va">data_grouped</span>, 
                             year_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">number</span><span class="op">)</span>, 
                             .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span>

<span class="co"># spread the year_total column into columns by year</span>
<span class="va">data_spread</span> <span class="op">&lt;-</span> <span class="fu">spread</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_summarised</span>, 
                      key <span class="op">=</span> <span class="va">year</span>, 
                      value <span class="op">=</span> <span class="va">year_total</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span>
  path <span class="op">=</span> <span class="st">"data/widgets_gadgets.xlsx"</span>, 
  skip <span class="op">=</span> <span class="fl">2</span>,
  col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"customer_id"</span>, 
                <span class="st">"widgets_2020"</span>, 
                <span class="st">"widgets_2021"</span>, 
                <span class="st">"gadgets_2020"</span>, 
                <span class="st">"gadgets_2021"</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">gather</span><span class="op">(</span>key <span class="op">=</span> <span class="va">item_year</span>, value <span class="op">=</span> <span class="va">number</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">separate</span><span class="op">(</span>col <span class="op">=</span> <span class="va">item_year</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"item"</span>, <span class="st">"year"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">item</span>, <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>year_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">number</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">spread</span><span class="op">(</span>key <span class="op">=</span> <span class="va">year</span>, value <span class="op">=</span> <span class="va">year_total</span><span class="op">)</span></code></pre></div>
<p>You can read this code from top to bottom as follows:</p>
<ol style="list-style-type: decimal">
<li>Read in an excel file
<ul>
<li>at the <em>path</em> <code class="path">data/widgets_gadgets.xlsx</code>
</li>
<li>
<em>skip</em>ping the first two rows,</li>
<li>with new <em>col</em>umn <em>names</em>; <strong>and then</strong>
</li>
</ul>
</li>
<li>Gather to create a <em>key</em> column <code>item_year</code> and <em>value</em> column <code>number</code> from columns 2 to 5; <strong>and then</strong>
</li>
<li>Separate the <em>col</em>umn <code>item_year</code> <em>into</em> 2 new columns called <code>item</code> and <code>year</code>, <em>sep</em>arate at the "_"; <strong>and then</strong>
</li>
<li>Group by columns <code>item</code> and <code>year</code>; <strong>and then</strong>
</li>
<li>Summarise and new column called <code>year_total</code> as the sum of the <code>number</code> column for each group and drop <em>groups</em>; <strong>and then</strong>
</li>
<li>Mutate the table to add a new column called <code>total</code> that is the sum of the <code>year_total</code> column for each group; <strong>and then</strong>
</li>
<li>Spread to make new columns with the <em>key</em> names in <code>year</code> and <em>value</em>s in <code>year_total</code>
</li>
</ol>
</div>
</div>
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  if (t = document.getElementById("webex-total_correct")) {
    t.innerHTML =
      document.getElementsByClassName("webex-correct").length + " of " +
      document.getElementsByClassName("webex-solveme").length + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

window.onload = function() {
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;
  }

  update_total_correct();
}

</script><script>
$( document ).ready(function() {
  var cite = ' ';
  var psyteachr = ' <a href="https://psyteachr.github.io/"><img src="images/logos/psyteachr_logo.png" style="height: 31px; color: white;" alt="psyTeachR: Reproducible Research" /></a>';
  var license = ' <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/" target="blank"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"></a>';

  $("footer div.row div:eq(1) p").html(
    psyteachr + license + cite
  );
});
</script><div class="chapter-nav">
<div class="prev"><a href="data.html"><span class="header-section-number">4</span> Data Import and Relations</a></div>
<div class="next"><a href="wrangle.html"><span class="header-section-number">6</span> Data Wrangling</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#tidy"><span class="header-section-number">5</span> Data Tidying</a></li>
<li><a class="nav-link" href="#ilo-tidy"><span class="header-section-number">5.1</span> Intended Learning Outcomes</a></li>
<li>
<a class="nav-link" href="#data-tidying"><span class="header-section-number">5.2</span> Data Tidying</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#untidy-data"><span class="header-section-number">5.2.1</span> Untidy data</a></li>
<li><a class="nav-link" href="#tidy-data"><span class="header-section-number">5.2.2</span> Tidy data</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#reshaping-data"><span class="header-section-number">5.3</span> Reshaping Data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#too-many-observations-per-row"><span class="header-section-number">5.3.1</span> Too many observations per row</a></li>
<li><a class="nav-link" href="#too-many-variables-per-column"><span class="header-section-number">5.3.2</span> Too many variables per column</a></li>
<li><a class="nav-link" href="#changing-data"><span class="header-section-number">5.3.3</span> Changing data</a></li>
<li><a class="nav-link" href="#fixing-data-types"><span class="header-section-number">5.3.4</span> Fixing data types</a></li>
</ul>
</li>
<li><a class="nav-link" href="#pipes"><span class="header-section-number">5.4</span> Pipes</a></li>
<li><a class="nav-link" href="#exercise"><span class="header-section-number">5.5</span> Exercise</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/psyteachr/ads-v1/blob/master/book/05-tidy.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/psyteachr/ads-v1/edit/master/book/05-tidy.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Applied Data Skills</strong>: Processing &amp; Presenting Data" was written by Emily Nordmann and Lisa DeBruine. It was last built on 2021-09-07.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
